# 機能要件

## 1.1 ビジネス要件

**主目的**: Slack ワークスペース上で AI 機能を提供し、Slack ユーザーがリクエストに対して適切なレスポンスを得られるようにする。

**主要機能**:

- Slack コマンド（`/ask`、`/generate`、`/analyze` など）またはメンション（`@bot`）で AI 機能を利用できる
- **スレッド返信機能**: ボットの応答はスレッド内に投稿され、会話が整理される
- **スレッド履歴保持**: スレッド内の過去の会話を参照し、文脈を理解した応答を提供
- **添付ファイル処理**: 画像（PNG, JPEG, GIF, WebP）とドキュメント（PDF, DOCX, CSV, XLSX, PPTX, TXT）の添付ファイルを処理し、AI 分析に含める
- **画像分析**: AWS Bedrock の視覚機能を使用して画像内容を分析
- **ドキュメント抽出**: ドキュメントからテキストを抽出し、AI 処理に含める
- **PPTX スライド変換**: PowerPoint スライドを画像に変換して視覚分析を実行
- **複数添付ファイル対応**: 1 つのメッセージに複数の添付ファイルがある場合、すべてを処理
- コンテキスト履歴を保持し、前のリクエストのコンテキストを理解した処理が可能
- 会話、画像生成、コード生成、データ分析など多様な AI 機能に対応
- 日本語を含む多言語対応
- 即座のフィードバック（2 秒以内）と非ブロッキング処理

**非機能要件**:

- 初期応答時間: ≤2 秒（p95）
- 最終回答時間: 5〜30 秒（p95）
- 可用性: ≥99.5%
- コスト: ユーザー単位で$10/月以下

## 1.2 機能仕様

### コア機能

1. **リクエスト受付**

   - Slack スラッシュコマンド `/ask "リクエスト内容"` でリクエストを受け付ける
   - Slack メンション `@bot リクエスト内容` でもリクエストを受け付ける
   - **Two-Key Defense セキュリティ**: すべてのリクエストは以下の検証を通過する必要がある:
     - **鍵1**: HMAC SHA256 署名検証（Signing Secret）
     - **鍵2**: Slack API Existence Check（Bot Token） - team_id, user_id, channel_id の実在性確認
   - リクエストは即座に「処理中です...」という応答で確認される

2. **AI 処理実行**

   - AWS Bedrock Converse API を使用して処理を実行（統一インターフェース、マルチモーダル対応）
   - **スレッド返信**: メンションやDMへの応答はスレッド内に投稿される（`chat.postMessage` with `thread_ts`）
   - **スレッド履歴取得**: `conversations.replies` APIでスレッド内の過去のメッセージを取得し、Bedrock Converse API に会話履歴として渡すことで文脈を理解した応答を実現
   - **添付ファイル処理**: メッセージに添付ファイルがある場合、画像は視覚分析に、ドキュメントはテキスト抽出後に AI 処理に含める
   - **画像処理**: PNG, JPEG, GIF, WebP 形式の画像をダウンロードし、Bedrock Converse API の視覚機能で分析（バイナリデータ、Base64不要）
   - **ドキュメント処理**: PDF, DOCX, CSV, XLSX, PPTX, TXT 形式のドキュメントからテキストを抽出し、AI 処理に含める
   - **PPTX 処理**: PowerPoint スライドを LibreOffice を使用して画像に変換し、テキスト抽出と画像分析の両方を実行（オプション機能）
   - **複数添付ファイル**: 1 つのメッセージに複数の添付ファイルがある場合、すべてを順次処理し、統合された応答を提供
   - スレッド履歴を考慮した文脈のある処理（スレッド内の会話を参照）
   - レスポンスは Slack スレッド内に投稿される（`chat.postMessage` with `thread_ts`）
   - 会話、画像生成、コード生成、データ分析など多様な AI 機能に対応

3. **スレッド履歴管理**

   - スレッド内の会話履歴を `conversations.replies` APIで取得
   - Bedrock Converse API に会話履歴として渡すことで文脈を理解した応答を実現
   - スレッド単位で会話が整理される
   - スレッド履歴取得に失敗した場合、履歴なしで応答する（graceful degradation）

4. **エラーハンドリング**
   - タイムアウト時の適切なエラーメッセージ
   - トークン数超過時の通知
   - システムエラー時のユーザーフレンドリーなメッセージ
   - AI 機能タイプに応じた適切なエラーハンドリング
   - **添付ファイルエラー**: ダウンロード失敗、ファイルサイズ超過、未対応ファイル形式など、すべてのエラーに対してユーザーフレンドリーなメッセージを返す
   - **部分成功処理**: 複数添付ファイルがある場合、一部が失敗しても成功したファイルは処理を継続

### 制約事項

- Slack の 3 秒タイムアウト制約を回避するため、非同期処理が必要（Execution API経由）
- Bedrock Converse API の処理時間（5〜30 秒）を考慮した設計
- **スレッド履歴制限**: `conversations.replies` APIのデフォルト制限（最大20メッセージ）を考慮
- **添付ファイルサイズ制限**: 画像は最大 10MB、ドキュメントは最大 5MB（処理時間とメモリ使用量を考慮）
- **添付ファイル処理時間**: 画像 5MB 未満、ドキュメント 2MB 未満の場合、30 秒以内に処理完了
- **対応ファイル形式**: 画像（PNG, JPEG, GIF, WebP）、ドキュメント（PDF, DOCX, CSV, XLSX, PPTX, TXT）のみ対応
- **PPTX 変換**: LibreOffice Lambda Layer が必要（オプション機能）
- **Bedrock Converse API**: 画像は最大 5MB（Converse APIの制限）

---

## 関連ドキュメント

- [アーキテクチャ概要](../architecture/overview.md) - システム全体像と設計原則
- [ユーザー体験](../architecture/user-experience.md) - エンドユーザーフローと UX
- [セキュリティ要件](../security/requirements.md) - 機能的・非機能的セキュリティ要件
- [実装ロードマップ](../implementation/roadmap.md) - 実装計画とフェーズ
