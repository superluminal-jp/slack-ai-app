# セキュリティ要件

> **🔒 セキュリティファースト原則**
>
> 本システムは、AI の特性を考慮した**多層認証・認可**を採用しています。
> すべてのリクエストは以下の認証・認可レイヤーを通過する必要があります：
>
> 1. ✅ Slack 署名検証（HMAC SHA256）
> 2. ✅ Slack API 動的実在性確認（team_id, user_id, channel_id）
> 3. ✅ ホワイトリスト認可
> 4. ✅ IAM 認証（内部 API）
>
> **2 鍵防御**: いずれかの鍵（Signing Secret または Bot Token）が漏洩しても、
> 両方なければ攻撃は成功しません。

## 防御可能な脅威一覧

本システムの多層防御アーキテクチャは、以下の脅威に対して効果的な防御を提供します：

### 認証・認可関連の脅威

- **T-01: 署名シークレット漏洩** → 2 鍵防御（Existence Check）により影響を「高」から「中」に軽減
- **T-02: Slack アカウント乗っ取り** → SSO + MFA、IP 制限で防御
- **T-03: リプレイアタック** → タイムスタンプ検証（±5 分）で防御
- **T-04: API Gateway URL 漏洩** → 署名検証により不正アクセスをブロック
- **T-05: Lambda IAM ロール侵害** → 最小権限の原則、認証情報ローテーション
- **T-08: 権限昇格** → ホワイトリスト認可、IAM ポリシーレビュー

### AI 特有の脅威

- **T-11: モデル乱用（コスト）** → トークン制限（モデル最大値）、ユーザー単位レート制限
- **T-12: コンテキスト履歴情報漏洩** → コンテキスト ID 分離、DynamoDB 暗号化
- **T-13: プロンプトインジェクション** → パターンベース検出、入力検証強化

### その他の脅威

- **T-06: コマンドインジェクション** → 入力検証、パラメータ化クエリ、プロンプトインジェクション検出
- **T-07: DDoS / レート乱用** → DynamoDB ベースのユーザー単位スロットリング（実装済み）

## 認証・認可フロー

```text
┌─────────────────────────────────────────────────────────────┐
│ 1. Slack User Request                                       │
│    ↓ SSO + MFA (Slack レイヤー)                            │
├─────────────────────────────────────────────────────────────┤
│ 2. SlackEventHandler Function URL                            │
│    ↓ Function URL (認証なし、署名検証はLambda内で実施)      │
├─────────────────────────────────────────────────────────────┤
│ 3. SlackEventHandler (検証層)                                │
│    ├─ 3a. 署名検証 (Signing Secret) ← 鍵1                  │
│    ├─ 3b. Existence Check (Bot Token) ← 鍵2                │
│    │   └─ Slack API (team.info, users.info, conversations) │
│    └─ 3c. 認可 (ホワイトリスト)                            │
│    ↓ すべて成功時のみ次へ                                   │
├─────────────────────────────────────────────────────────────┤
│ 4. ExecutionApi (IAM 認証)                                   │
│    ↓                                                         │
├─────────────────────────────────────────────────────────────┤
│ 5. BedrockProcessor → Bedrock                                │
│    └─ Guardrails                                            │
└─────────────────────────────────────────────────────────────┘
```

## 4.1 機能的セキュリティ要件

### SR-01: Slack 署名検証

- Slack からのすべてのリクエストは、HMAC SHA256 署名を使用して検証されなければなりません
- タイムスタンプが ±5 分以内であることを確認し、リプレイアタックを防止

### SR-02: 認可

- team_id、user_id、channel_id によるホワイトリスト認可

### SR-03: トークン数制限（AI 特有）

- 各リクエストはモデルが許容する最大トークン数を使用します
- モデルごとの最大値:
  - Claude 4.5 Sonnet/Haiku/Opus: 8192 tokens (すべての4.5シリーズ)
  - Amazon Nova Pro: 8192 tokens
  - Amazon Nova Lite: 4096 tokens
- 環境変数 `BEDROCK_MAX_TOKENS` で上書き可能

### SR-04: Slack API Existence Check (Dynamic Entity Verification)

すべてのリクエストは、Slack API を使用して team_id、user_id、channel_id が実在するエンティティであることを動的に検証しなければなりません。

**セキュリティモデル**:

- Slack API (team.info, users.info, conversations.info) による実在性確認

### SR-05: 添付ファイルセキュリティ

添付ファイル処理に関するセキュリティ要件：

- **SR-07-01**: ファイルサイズ検証 - 画像は最大 10MB、ドキュメントは最大 5MB を超えるファイルは処理を拒否
- **SR-07-02**: ファイルタイプ検証 - 対応ファイル形式（画像: PNG, JPEG, GIF, WebP、ドキュメント: PDF, DOCX, CSV, XLSX, PPTX, TXT）のみ処理
- **SR-07-03**: ダウンロード URL 検証 - Slack CDN からのダウンロードのみ許可、`files.info` API を使用して最新の URL を取得
- **SR-07-04**: ボットトークン認証 - すべてのファイルダウンロードはボットトークンで認証
- **SR-07-05**: メモリ保護 - 大きなファイルによるメモリ枯渇を防ぐため、ファイルサイズを事前に検証
- **SR-07-06**: タイムアウト保護 - ファイルダウンロードと処理にタイムアウトを設定（30 秒）
- **SR-07-07**: エラーハンドリング - すべての添付ファイル処理エラーはユーザーフレンドリーなメッセージにマッピングし、システム情報を漏洩しない
- Bot Token (xoxb-...) を使用した API 呼び出し
- 2 鍵防御モデル: Signing Secret と Bot Token の両方が必要

**実装レイヤー**: SlackEventHandler（検証層）

**キャッシュ戦略**:

- 検証成功したエンティティを 5 分間キャッシュ（DynamoDB）
- キャッシュキー: `{team_id}#{user_id}#{channel_id}`
- TTL: 300 秒

**パフォーマンス要件**: Slack API 呼び出しレイテンシ ≤500ms (p95)

## 4.2 非機能的セキュリティ要件

| ID     | 要件                               | 目標値                          | 測定方法                       |
| ------ | ---------------------------------- | ------------------------------- | ------------------------------ |
| NFR-01 | 署名検証レイテンシ                 | ≤50ms（p99）                    | CloudWatch メトリクス          |
| NFR-02 | シークレットローテーション         | 90 日ごと                       | AWS Secrets Manager            |
| NFR-03 | 認証失敗アラートレイテンシ         | ≤1 分                           | CloudWatch アラーム            |
| NFR-04 | セキュリティログ保持               | 365 日                          | S3 + Glacier                   |
| NFR-05 | IAM ポリシーレビュー               | 30 日ごと                       | 手動監査                       |
| NFR-06 | 脆弱性スキャン                     | 週次                            | Snyk、Trivy                    |
| NFR-07 | ペネトレーションテスト             | 四半期ごと                      | 外部企業                       |
| NFR-08 | Bedrock 呼び出しレイテンシ         | ≤5 秒（p95）                    | CloudWatch メトリクス          |
| NFR-09 | ユーザー単位 Bedrock コスト        | ≤$10/月                         | Cost Explorer                  |
| NFR-10 | コンテキスト履歴暗号化             | すべての DynamoDB データ        | KMS 暗号化確認                 |
| NFR-11 | Existence Check レイテンシ         | ≤500ms（p95、キャッシュミス時） | CloudWatch メトリクス          |
| NFR-12 | Existence Check キャッシュヒット率 | ≥80%                            | DynamoDB + CloudWatch          |
| NFR-13 | Slack API 呼び出し成功率           | ≥99%                            | CloudWatch メトリクス          |
| NFR-14 | レート制限超過アラートレイテンシ   | ≤1 分                           | CloudWatch アラーム            |
| NFR-15 | PII ログマスキング                 | 100% (すべてのログレベル)       | ログ監査                       |
| NFR-16 | プロンプトインジェクション検出率     | ≥90% (既知パターン)             | セキュリティログ               |

---

## 関連ドキュメント

- [**認証・認可セキュリティ解説**](./authentication-authorization.md) - 認証・認可の詳細解説（Two-Key Defense、各レイヤーの説明、攻撃シナリオ）
- [アーキテクチャ概要](../architecture/overview.md) - セキュリティ設計の原則
- [脅威モデル](./threat-model.md) - リスク分析とアクター
- [セキュリティ実装](./implementation.md) - 多層防御の実装詳細
- [テストと検証](../operations/testing.md) - セキュリティ検証シナリオ
- [ADR-004](../adr/004-slack-api-existence-check.md) - Existence Check の採用理由
