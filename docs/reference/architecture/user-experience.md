# ユーザー体験

## 3.1 エンドユーザー体験フロー

### 正常系（成功シナリオ）

**ステップ 1: ユーザーが Slack コマンドまたは @メンションを実行**

```
ユーザー: /ask AWS Bedrockの主な特徴は何ですか？
または
ユーザー: @AIアプリ名 AWS Bedrockの主な特徴は何ですか？
```

- ユーザーは Slack のメッセージ入力欄に `/ask` コマンドまたは `@AIアプリ名` メンションとリクエストを入力
- Enter キーを押すと即座にコマンドが Slack に送信される
- **UI 表示**: コマンドまたはメンションがチャンネルに投稿される
- **@メンションによる直接利用**: `@AIアプリ名 質問内容` のようにメンションするだけで AI アプリを直接利用可能

**ステップ 2: 即座のフィードバック（0.5〜2 秒後）**

```
[Bot] 処理中です... 少々お待ちください
```

- SlackEventHandler が 3 秒以内にこの応答を返す
- ユーザーには「処理が受け付けられた」という視覚的フィードバックが表示される
- この時点で Slack の 3 秒タイムアウト制約はクリアされている
- **体験ポイント**: ユーザーは即座に応答があるため、システムが動作していることを確認できる

**ステップ 3: バックグラウンド処理（5〜30 秒間）**

- ユーザー側では何も表示されないが、バックグラウンドで以下が実行されている:
  - BedrockProcessor が SlackEventHandler から API Gateway 経由で起動
  - Bedrock Foundation Model がリクエストを処理（会話、画像生成、コード生成など）
  - response_url への POST 準備
- **体験ポイント**: この間、ユーザーは他の作業を継続できる（非ブロッキング）

**ステップ 4: 最終レスポンスの表示（5〜30 秒後）**

```
[ユーザーのメッセージ]
@Bedrock Bot AWS Bedrockの主な特徴は何ですか？

[Bot] AIレスポンス: (スレッド内に表示)
AWS Bedrockの主な特徴は以下の通りです：

1. 多様なFoundation Model: Claude、Titan、Llamaなど複数のモデルから選択可能
2. セキュアな実行環境: 多層防御による安全な実行
3. Guardrails統合: 有害コンテンツを自動検出
4. エンタープライズ対応: IAM、CloudWatch、CloudTrailによる統合管理
5. コスト効率: 使用量ベースの課金で柔軟なコスト管理

ご質問があればお気軽にお尋ねください。
```

- **スレッド返信**: ボットの応答は元のメッセージへのスレッド返信として表示される
- チャンネルが整理され、会話の流れが明確になる
- マークダウン形式でフォーマットされた読みやすい回答
- **体験ポイント**: スレッド内で会話が整理され、過去の会話も参照しやすい

### 問い合わせチャンネルでの自動一次回答の体験フロー

**ステップ 1: ユーザーが問い合わせチャンネルに質問を投稿**

```
ユーザー: 申請書の提出期限はいつですか？
```

- ユーザーは問い合わせ系チャンネルに質問を投稿
- 職員が応答する前に、専用の AI アプリが自動的に一次回答を返信
- **UI 表示**: 質問がチャンネルに投稿される

**ステップ 2: 自動一次回答の表示（5〜30 秒後）**

```
[ユーザーのメッセージ]
ユーザー: 申請書の提出期限はいつですか？

[Bot] AI一次回答: (スレッド内に表示)
申請書の提出期限は、各申請書類によって異なります。一般的には以下の通りです：

1. 通常の申請書: 月末締切
2. 緊急申請: 随時受付
3. 特別申請: 各部署に確認が必要

詳細については、各部署の担当者にお問い合わせください。
```

- **自動一次回答**: 問い合わせチャンネルに投稿された質問に対して、専用の AI アプリが自動的に一次回答を返信
- **職員の負担軽減**: 基本的な質問には AI が自動応答し、職員は複雑な質問に集中できる
- **存在の認知**: 自動応答により、職員は AI アプリの存在と機能を自然に知ることができる
- **24 時間対応**: 職員が不在でも、基本的な問い合わせには自動的に回答可能
- **スレッド返信**: ボットの応答は元のメッセージへのスレッド返信として表示される

**ステップ 3: 職員による追加対応（必要に応じて）**

```
[職員] 上記の回答で問題ありませんが、追加でご不明な点があればお気軽にお問い合わせください。
```

- 職員は AI の一次回答を確認し、必要に応じて追加情報を提供
- 複雑な質問には職員が直接対応

### 添付ファイル付きメッセージの体験フロー

**ステップ 1: ユーザーが画像を添付してメッセージを送信**

```
ユーザー: [画像を添付] この画像について説明してください
```

- ユーザーは画像やドキュメントを添付してメッセージを送信
- テキストのみ、添付ファイルのみ、または両方の組み合わせが可能

**ステップ 2: 即座のフィードバック（0.5〜2 秒後）**

```
[Bot] 処理中です... 少々お待ちください
```

- 添付ファイルの有無に関わらず、即座に応答が返される
- ユーザーは処理が開始されたことを確認できる

**ステップ 3: バックグラウンド処理（5〜30 秒間）**

- バックグラウンドで以下が実行される:
  - **画像処理**: 画像を Slack CDN からダウンロードし、Bedrock の視覚機能で分析
  - **ドキュメント処理**: ドキュメントからテキストを抽出し、AI 処理に含める
  - **PPTX 処理**: PowerPoint スライドを画像に変換し、テキストと画像の両方を分析
  - **複数添付ファイル**: 複数の添付ファイルがある場合、すべてを順次処理
  - Bedrock Foundation Model がテキストと画像/ドキュメント内容を統合して処理

**ステップ 4: 最終レスポンスの表示（5〜30 秒後）**

```
[ユーザーのメッセージ]
[画像: スクリーンショット] この画像について説明してください

[Bot] AIレスポンス: (スレッド内に表示)
この画像は、AWS Bedrock の管理コンソールのスクリーンショットです。
画面には以下の要素が表示されています：

1. モデル選択画面: Claude、Titan、Llama などのモデルが一覧表示
2. Guardrails 設定: 有害コンテンツ検出の設定
3. 使用量メトリクス: API 呼び出し回数とコスト情報

ご質問があればお気軽にお尋ねください。
```

- **画像分析**: 画像の内容を理解し、詳細な説明を提供
- **ドキュメント分析**: ドキュメントの内容を理解し、質問に回答
- **統合分析**: テキストと添付ファイルの内容を統合して包括的な応答を提供

**ステップ 5: スレッド内での継続的な会話（オプション）**

```
[ユーザー] (スレッド内で返信)
さっき何を言った？

[Bot] (スレッド内で返信)
先ほど「AWS Bedrockの主な特徴」について説明しました...
```

- ユーザーがスレッド内で返信すると、ボットは同じスレッド内で応答
- **スレッド履歴取得**: ボットはスレッド内の過去のメッセージを参照し、文脈を理解した応答を提供
- **体験ポイント**: 会話の文脈が保持され、自然な対話が可能

**タイミングサマリー**:
| ステップ | 時間 | ユーザーの状態 |
|---------|------|--------------|
| コマンド送信 | 0 秒 | アクティブ |
| 初期応答 | 0.5〜2 秒 | 確認完了 |
| 処理中 | 2〜30 秒 | 待機（他作業可能） |
| 最終レスポンス | 5〜30 秒 | レスポンス確認 |

---

### エラーシナリオ

**シナリオ 1: タイムアウトエラー（Bedrock 処理が 300 秒を超過）**

```
[Bot] 処理中です... 少々お待ちください
[5分後]
[Bot] エラー: 処理がタイムアウトしました。もう一度お試しください。
```

- **頻度**: 稀（通常 5〜30 秒で完了）
- **対応**: ユーザーはリクエストを短くするか、再試行

**シナリオ 2: 認証エラー（不正な Slack 署名）**

**ステップ 1: ユーザーが不正な署名でリクエストを送信**

- 攻撃者が Signing Secret を漏洩させ、偽造リクエストを送信
- システムは署名検証（鍵1）で不正リクエストを検出

**ステップ 2: 即座の拒否（0.5〜1 秒後）**

```
[システム] 401 Unauthorized: Invalid signature
```

- SlackEventHandler が 401 を返す
- リクエストは処理されない
- **体験ポイント**: 攻撃者は署名検証でブロックされる
- **頻度**: 極稀（攻撃試行時）
- **ログ**: CloudWatch Logs にセキュリティイベントとして記録

**シナリオ 3: Existence Check エラー（偽造エンティティ ID）**

**ステップ 1: 攻撃者が偽造 team_id でリクエストを送信**

- 攻撃者が Signing Secret を漏洩させ、有効な署名を持つが偽造 team_id を含むリクエストを送信
- システムは署名検証（鍵1）を通過するが、Existence Check（鍵2）で失敗

**ステップ 2: 即座の拒否（0.5〜2 秒後）**

```
[システム] 403 Forbidden: Entity verification failed
```

- SlackEventHandler が Existence Check を実行
- Slack API が team_id が存在しないことを返す
- システムは 403 を返し、セキュリティイベントをログに記録
- **体験ポイント**: Two-Key Defense により、Signing Secret 漏洩だけでは攻撃が成功しない
- **頻度**: 攻撃試行時（Signing Secret 漏洩後）
- **ログ**: CloudWatch Logs に "existence_check_failed" イベントとして記録

**シナリオ 4: Existence Check キャッシュヒット**

**ステップ 1: ユーザーが同じ team/user/channel から2回目のリクエストを送信**

- 最初のリクエストで Existence Check が成功し、DynamoDB にキャッシュされる（5分TTL）
- 2回目のリクエストではキャッシュから結果を取得

**ステップ 2: 高速な検証（<50ms）**

- Existence Check がキャッシュヒットし、Slack API 呼び出しをスキップ
- リクエスト処理が高速化される
- **体験ポイント**: パフォーマンスが最適化され、ユーザー体験が向上
- **頻度**: 同じ team/user/channel からの連続リクエスト時（5分以内）
- **ログ**: CloudWatch Logs に "existence_check_cache_hit" イベントとして記録

**シナリオ 5: トークン数超過**

```
ユーザー: /ask [非常に長いリクエスト + 長いコンテキスト履歴]
[Bot] 処理中です... 少々お待ちください
[3秒後]
[Bot] エラー: リクエストが長すぎます。`/reset` コマンドでコンテキストをリセットしてから再試行してください。
```

- **頻度**: 長い処理セッション後
- **対応**: ユーザーに明確なアクション指示

**シナリオ 6: 添付ファイルダウンロード失敗**

```
ユーザー: [画像を添付] この画像について説明してください
[Bot] 処理中です... 少々お待ちください
[5秒後]
[Bot] エラー: 画像のダウンロードに失敗しました。画像が共有されているチャンネルにボットが追加されているか、画像が削除されていないか確認してください。
```

- **頻度**: 画像が削除された、またはボットにアクセス権限がない場合
- **対応**: 明確なエラーメッセージと解決方法の提示

**シナリオ 7: 未対応ファイル形式**

```
ユーザー: [ZIPファイルを添付] このファイルについて説明してください
[Bot] 処理中です... 少々お待ちください
[3秒後]
[Bot] エラー: このファイル形式には対応していません。画像（PNG, JPEG, GIF, WebP）またはドキュメント（PDF, DOCX, CSV, XLSX, PPTX, TXT）を送信してください。
```

- **頻度**: 未対応ファイル形式を送信した場合
- **対応**: 対応ファイル形式を明示したエラーメッセージ

**シナリオ 8: ファイルサイズ超過**

```
ユーザー: [大きな画像（15MB）を添付] この画像について説明してください
[Bot] 処理中です... 少々お待ちください
[3秒後]
[Bot] エラー: 画像が大きすぎます（最大 10MB）。より小さな画像を送信してください。
```

- **頻度**: ファイルサイズ制限を超えた場合
- **対応**: サイズ制限と解決方法を明示

---

## 3.2 ユーザー体験の特徴

**ポジティブな点**:

1. **即座のフィードバック**: 2 秒以内に「処理中」の応答が得られる
2. **非同期処理**: ユーザーは待機中に他の作業を継続できる（非ブロッキング）
3. **スレッド返信**: ボットの応答がスレッド内に整理され、チャンネルが散らからない
4. **スレッド履歴保持**: スレッド内の過去の会話を参照し、文脈を理解した応答が可能
5. **添付ファイル対応**: 画像やドキュメントを添付して AI 分析を実行できる
6. **画像分析**: 画像の内容を理解し、詳細な説明を提供
7. **ドキュメント分析**: ドキュメントの内容を理解し、質問に回答
8. **複数添付ファイル**: 1 つのメッセージに複数の添付ファイルがある場合、すべてを処理
9. **視覚的に明確**: AI のレスポンスはマークダウン形式で読みやすい
10. **透明性**: エラーが発生した場合も明確なメッセージが表示される
11. **コンテキスト履歴**: 前のリクエストを覚えており、コンテキストを維持
12. **多様な AI 機能**: 会話、画像生成、コード生成、データ分析などに対応

**注意点**:

1. **待機時間**: 最終レスポンスまで 5〜30 秒かかる（Bedrock の処理時間に依存）
2. **スレッド返信**: メンションやDMへの応答はスレッド内に投稿される（チャンネルに新規メッセージとして投稿されない）
3. **スレッド履歴**: スレッド履歴の取得に失敗した場合、履歴なしで応答する（graceful degradation）
4. **可視性**: スレッド返信はスレッドを開いたユーザーにのみ表示される（チャンネル全体には表示されない）
5. **機能タイプ**: AI 機能の種類によって処理時間やレスポンス形式が異なる場合がある
7. **添付ファイルサイズ制限**: 画像は最大 10MB、ドキュメントは最大 5MB
8. **対応ファイル形式**: 画像（PNG, JPEG, GIF, WebP）、ドキュメント（PDF, DOCX, CSV, XLSX, PPTX, TXT）のみ対応
9. **PPTX 変換**: LibreOffice Lambda Layer が必要（オプション機能）
10. **部分成功**: 複数添付ファイルがある場合、一部が失敗しても成功したファイルは処理を継続

---

## 3.3 監査・ログの視点

管理者が CloudWatch Logs で確認できる情報:

```json
{
  "correlation_id": "req-abc123",
  "timestamp": "2025-11-30T10:15:30Z",
  "event": "slack_request_received",
  "team_id": "T12345",
  "user_id": "U67890",
  "channel_id": "C11111",
  "user_message_hash": "sha256:...",
  "bedrock_model_id": "us.anthropic.claude-sonnet-4-5-20250929-v1:0", // モデルは要件に応じて選択
  "ai_function_type": "conversation", // conversation, image_generation, code_generation, data_analysis など
  "bedrock_latency_ms": 5234,
  "guardrail_action": "NONE",
  "response_posted": true
}
```

これにより、以下が追跡可能:

- 誰が、いつ、どのチャンネルでリクエストしたか
- どの AI 機能タイプが使用されたか
- Bedrock の処理時間
- エラーやタイムアウト
- コスト追跡（トークン数、リクエスト数）

---

## 3.4 パフォーマンス期待値

| メトリクス            | 目標値          | 測定方法             |
| --------------------- | --------------- | -------------------- |
| 初期応答時間          | ≤2 秒（p95）    | CloudWatch Logs      |
| Bedrock 処理時間      | 5〜30 秒（p95） | CloudWatch Metrics   |
| 全体レイテンシ        | ≤35 秒（p99）   | エンドツーエンド測定 |
| 成功率                | ≥99.5%          | CloudWatch Metrics   |
| Guardrails ブロック率 | <1%（通常使用） | CloudWatch Logs      |

---

## 関連ドキュメント

- [機能要件](../requirements/functional-requirements.md) - ビジネス要件と機能仕様
- [アーキテクチャ概要](./overview.md) - システム全体像と設計原則
- [実装詳細](./implementation-details.md) - Lambda構成とデータフロー
- [テストと検証](../operations/testing.md) - テスト戦略と検証手順
- [モニタリング](../operations/monitoring.md) - 運用監視とインシデント対応
