# 機能要件

**目的**: ビジネス目標、機能要件、非機能要件、制約を定義する。
**対象読者**: 開発者、プロダクトオーナー
**最終更新日**: 2026-02-14

---

## 1.1 ビジネス要件

**主目的**: Slack ワークスペース上で AI 機能を提供し、Slack ユーザーがリクエストに対して適切なレスポンスを得られるようにする。

**主要機能**:

- **@メンションによる直接利用**: Slack 上で `@AIアプリ名 質問内容` のようにメンションするだけで AI アプリを直接利用できる
- **問い合わせチャンネルでの自動一次回答**: 問い合わせ系チャンネルでは、一次回答を自動的に専用の AI アプリから返信し、職員の負担を軽減
- **将来の機能**: Slack コマンド（`/ask`、`/generate`、`/analyze` など）でも AI 機能を利用できる（現在は未実装）
- **スレッド返信機能**: ボットの応答はスレッド内に投稿され、会話が整理される
- **スレッド履歴保持**: スレッド内の過去の会話を参照し、文脈を理解した応答を提供
- **添付ファイル処理**: 画像（PNG, JPEG, GIF, WebP）とドキュメント（PDF, DOCX, CSV, XLSX, PPTX, TXT）の添付ファイルを処理し、AI 分析に含める
- **画像分析**: AWS Bedrock の視覚機能を使用して画像内容を分析
- **ドキュメント抽出**: ドキュメントからテキストを抽出し、AI 処理に含める
- **PPTX スライド変換**: PowerPoint スライドを画像に変換して視覚分析を実行
- **複数添付ファイル対応**: 1 つのメッセージに複数の添付ファイルがある場合、すべてを処理
- コンテキスト履歴を保持し、前のリクエストのコンテキストを理解した処理が可能
- 会話、画像生成、コード生成、データ分析など多様な AI 機能に対応
- 日本語を含む多言語対応
- 即座のフィードバック（2 秒以内）と非ブロッキング処理

**非機能要件**:

- 初期応答時間: ≤2 秒（p95）
- 最終回答時間: Bedrock の処理完了後（処理時間はモデル、入力長、負荷状況に依存し、予測不可能）
- 可用性: ≥99.5%
- コスト: ユーザー単位で$10/月以下

## 1.2 機能仕様

### コア機能

1. **リクエスト受付**

   - **@メンションによる直接利用**: Slack 上で `@AIアプリ名 質問内容` のようにメンションするだけで AI アプリを直接利用可能
   - **将来の機能**: Slack スラッシュコマンド `/ask "リクエスト内容"` でリクエストを受け付ける（現在は未実装）
   - **問い合わせチャンネルでの自動一次回答**: 問い合わせ系チャンネルに投稿された質問に対して、専用の AI アプリが自動的に一次回答を返信
   - **Two-Key Defense セキュリティ**: すべてのリクエストは以下の検証を通過する必要がある:
     - **鍵1**: HMAC SHA256 署名検証（Signing Secret）
     - **鍵2**: Slack API Existence Check（Bot Token） - team_id, user_id, channel_id の実在性確認
   - リクエストは即座に「処理中です...」という応答で確認される

2. **AI 処理実行**

   - AWS Bedrock Converse API を使用して処理を実行（統一インターフェース、マルチモーダル対応）
   - **スレッド返信**: メンションやDMへの応答はスレッド内に投稿される（`chat.postMessage` with `thread_ts`）
   - **スレッド履歴取得**: `conversations.replies` APIでスレッド内の過去のメッセージを取得し、Bedrock Converse API に会話履歴として渡すことで文脈を理解した応答を実現
   - **添付ファイル処理**: メッセージに添付ファイルがある場合、画像は視覚分析に、ドキュメントはテキスト抽出後に AI 処理に含める
   - **画像処理**: PNG, JPEG, GIF, WebP 形式の画像をダウンロードし、Bedrock Converse API の視覚機能で分析（バイナリデータ、Base64不要）
   - **ドキュメント処理**: PDF, DOCX, CSV, XLSX, PPTX, TXT 形式のドキュメントからテキストを抽出し、AI 処理に含める
   - **PPTX 処理**: PowerPoint スライドを LibreOffice を使用して画像に変換し、テキスト抽出と画像分析の両方を実行（オプション機能）
   - **複数添付ファイル**: 1 つのメッセージに複数の添付ファイルがある場合、すべてを順次処理し、統合された応答を提供
   - スレッド履歴を考慮した文脈のある処理（スレッド内の会話を参照）
   - レスポンスは Slack スレッド内に投稿される（`chat.postMessage` with `thread_ts`）
   - 会話、画像生成、コード生成、データ分析など多様な AI 機能に対応

3. **スレッド履歴管理**

   - スレッド内の会話履歴を `conversations.replies` APIで取得
   - Bedrock Converse API に会話履歴として渡すことで文脈を理解した応答を実現
   - スレッド単位で会話が整理される
   - スレッド履歴取得に失敗した場合、履歴なしで応答する（graceful degradation）

4. **エラーハンドリング**
   - タイムアウト時の適切なエラーメッセージ
   - トークン数超過時の通知
   - システムエラー時のユーザーフレンドリーなメッセージ
   - AI 機能タイプに応じた適切なエラーハンドリング
   - **添付ファイルエラー**: ダウンロード失敗、ファイルサイズ超過、未対応ファイル形式など、すべてのエラーに対してユーザーフレンドリーなメッセージを返す
   - **部分成功処理**: 複数添付ファイルがある場合、一部が失敗しても成功したファイルは処理を継続

### 制約事項

- Slack の 3 秒タイムアウト制約を回避するため、非同期処理が必要（Execution API経由）
- Bedrock Converse API の処理時間（モデル、入力長、負荷状況に依存し、予測不可能）を考慮した設計
- **スレッド履歴制限**: `conversations.replies` APIのデフォルト制限（最大20メッセージ）を考慮
- **添付ファイルサイズ制限**: 画像は最大 10MB、ドキュメントは最大 5MB（処理時間とメモリ使用量を考慮）
- **添付ファイル処理時間**: 画像 5MB 未満、ドキュメント 2MB 未満の場合、Bedrock の処理完了後に応答（処理時間はモデル、入力長、負荷状況に依存）
- **対応ファイル形式**: 画像（PNG, JPEG, GIF, WebP）、ドキュメント（PDF, DOCX, CSV, XLSX, PPTX, TXT）のみ対応
- **PPTX 変換**: LibreOffice Lambda Layer が必要（オプション機能）
- **Bedrock Converse API**: 画像は最大 5MB（Converse APIの制限）

---

## 関連ドキュメント

- [アーキテクチャ概要](../reference/architecture/overview.md) - システム全体像と設計原則
- [ユーザー体験](../reference/architecture/user-experience.md) - エンドユーザーフローと UX
- [セキュリティ要件](../reference/security/requirements.md) - 機能的・非機能的セキュリティ要件

---

## 付録: 完了済みフェーズ（Roadmap）

> **注記**: 以下は実装ロードマップの歴史的記録である。すべてのフェーズは完了済みであり、現在の実装状態を示す参照資料として保持する。

### フェーズ 1: 基盤構築（Week 1-2）

**目標**: セキュアな基本アーキテクチャを構築

#### 優先度: 必須（P0）

1. **SlackEventHandler（検証層 Verification Layer）実装**

   - タスク: HMAC SHA256 署名検証、認可ロジック、非同期呼び出し
   - 成果物: `src/adapters/slack/verification_handler.py`
   - 検証: 署名検証テスト、認可テスト
   - 所要時間: 3 日

2. **Execution Agent（実行層 Execution Layer）実装**

   - タスク: Bedrock API 呼び出し、response_url 投稿
   - 成果物: `src/application/execution_handler.py`
   - 検証: Bedrock 接続テスト、多様な AI 機能タイプのテスト
   - 所要時間: 4 日

3. **DynamoDB コンテキスト履歴テーブル作成**

   - タスク: テーブル設計（コンテキスト ID、タイムスタンプ）、KMS 暗号化設定
   - 成果物: CloudFormation/Terraform テンプレート
   - 検証: データ暗号化確認、アクセスパターンテスト
   - 所要時間: 2 日

4. **IAM ポリシー設定**
   - タスク: SlackEventHandler、Execution Agent の最小権限ポリシー作成
   - 成果物: IAM Policy JSON ファイル
   - 検証: ポリシーバリデーター、権限過剰チェック
   - 所要時間: 2 日

**マイルストーン**: エンドツーエンドでリクエスト → レスポンスが動作

---

### フェーズ 1.5: 添付ファイル処理機能（Week 2-3）

**目標**: Slack メッセージの添付ファイル（画像・ドキュメント）を処理し、AI 分析に含める

#### 優先度: 高（P1-P2）

1. **添付ファイルメタデータ抽出** (SlackEventHandler)

   - タスク: `event.files` から添付ファイル情報を抽出
   - 成果物: `verification-zones/verification-agent/cdk/lib/lambda/slack-event-handler/attachment_extractor.py`
   - 検証: 各種ファイル形式のメタデータ抽出テスト
   - 所要時間: 1 日

2. **ファイルダウンロード機能** (Execution Agent)

   - タスク: Slack CDN からファイルをダウンロード（ボットトークン認証）
   - 成果物: `execution-zones/execution-agent/src/file_downloader.py`
   - 検証: ダウンロード成功/失敗のテスト
   - 所要時間: 2 日

3. **ドキュメントテキスト抽出** (Execution Agent)

   - タスク: PDF, DOCX, CSV, XLSX, PPTX, TXT からテキスト抽出
   - 成果物: `execution-zones/execution-agent/src/document_extractor.py`
   - 検証: 各形式のテキスト抽出テスト
   - 所要時間: 3 日

4. **画像処理統合** (Execution Agent)

   - タスク: 画像を Bedrock 視覚機能に送信
   - 成果物: `execution-zones/execution-agent/src/bedrock_client.py` の更新
   - 検証: 画像分析のテスト
   - 所要時間: 2 日

5. **添付ファイル処理オーケストレーション** (Execution Agent)

   - タスク: 複数添付ファイルの処理、エラーハンドリング
   - 成果物: `execution-zones/execution-agent/src/attachment_processor.py`
   - 検証: 複数ファイル、部分成功、エラーケースのテスト
   - 所要時間: 2 日

**マイルストーン**: 画像とドキュメントの添付ファイルが AI 分析に含まれる

---

### フェーズ 2: セキュリティ強化（Week 3-4）

**目標**: AI 特有の脅威に対する保護を実装、Two-Key Defense モデルの実装

#### 優先度: 高（P1）

4.5. **Slack API Existence Check (Two-Key Defense - 鍵2)**

   - タスク: team_id, user_id, channel_id の実在性を Slack API で動的に確認
   - 成果物: `verification-zones/verification-agent/cdk/lib/lambda/slack-event-handler/existence_check.py`
   - DynamoDB キャッシュテーブル作成（5分TTL）
   - エラーハンドリング（タイムアウト、レート制限、リトライ）
   - CloudWatch メトリクスとアラーム
   - 検証: 偽造リクエスト拒否テスト、キャッシュ動作テスト
   - 所要時間: 5 日

5. **Bedrock Guardrails 設定**

   - タスク: Guardrail 作成（Automated Reasoning、有害コンテンツ検出）
   - 成果物: Guardrail 設定（YAML/JSON）
   - 検証: 有害コンテンツフィルタテスト
   - 所要時間: 3 日

6. **CloudWatch Logs & Metrics 設定**
   - タスク: 構造化 JSON ログ、カスタムメトリクス（署名検証失敗）
   - 成果物: ログフィルタ、メトリクスフィルタ
   - 検証: ログ可視性確認、アラート動作確認
   - 所要時間: 2 日

**マイルストーン**: セキュリティ監査で脆弱性ゼロ

---

### フェーズ 3: 品質保証（Week 4）

**目標**: テスト自動化とドキュメント整備

#### 優先度: 中（P2）

7. **BDD テストスイート作成**

   - タスク: Gherkin シナリオ実装（署名検証）
   - 成果物: `tests/bdd/features/*.feature`、ステップ定義
   - 検証: CI/CD パイプラインで全シナリオ合格
   - 所要時間: 3 日

9. **パフォーマンステスト**

   - タスク: 負荷テスト（100 同時リクエスト）、レイテンシ測定
   - 成果物: パフォーマンステストレポート
   - 検証: p95 レイテンシ ≤35 秒
   - 所要時間: 2 日

10. **運用ドキュメント作成**
    - タスク: デプロイ手順、トラブルシューティングガイド
    - 成果物: `docs/operations/deployment-guide.md`
    - 検証: 第三者によるデプロイ再現
    - 所要時間: 2 日

**マイルストーン**: ステージング環境で本番同等の安定性

---

### フェーズ 4: 本番展開（Week 5）

**目標**: 段階的ロールアウトと監視

#### 優先度: 必須（P0）

11. **パイロット展開**

    - タスク: 10 ユーザーでベータテスト
    - 成果物: フィードバックレポート、バグ修正
    - 検証: ユーザー満足度スコア ≥4/5
    - 所要時間: 5 日

12. **本番モニタリング設定**

    - タスク: CloudWatch アラーム（エラー率、レイテンシ）、PagerDuty 統合
    - 成果物: アラーム設定、オンコールローテーション
    - 検証: テストアラートで通知確認
    - 所要時間: 2 日

13. **全社展開**
    - タスク: 段階的ロールアウト（10% → 50% → 100%）
    - 成果物: ロールアウト計画、ロールバック手順
    - 検証: 各段階でエラー率 <0.5%
    - 所要時間: 1 週間

**マイルストーン**: 全ユーザーが利用可能、インシデントゼロ

---

### フェーズ 5: スレッド返信機能（Week 6）✅ 完了

**目標**: スレッド返信と会話履歴保持機能の実装

#### 優先度: 高（P1）

17. **スレッド返信機能実装** ✅ 完了

    - タスク: Slack API `thread_ts` パラメータを使用したスレッド返信機能
    - 成果物: `execution-zones/execution-agent/src/slack_poster.py`、`verification-zones/verification-agent/cdk/lib/lambda/slack-event-handler/handler.py`
    - 検証: スレッド返信テスト、エラーハンドリングテスト
    - 完了日: 2025-12-06

18. **スレッド履歴取得機能実装** ✅ 完了

    - タスク: Slack API `conversations.replies` を使用したスレッド履歴取得
    - 成果物: `execution-zones/execution-agent/src/thread_history.py`
    - 検証: スレッド履歴取得テスト、会話コンテキストテスト
    - 完了日: 2025-12-06

19. **Slack OAuth スコープ更新** ✅ 完了

    - タスク: `channels:history`、`groups:history` スコープの追加
    - 成果物: `docs/reference/operations/slack-setup.md`、`docs/slack-app-manifest.yaml`
    - 検証: スコープ設定確認、再インストール確認
    - 完了日: 2025-12-06

**マイルストーン**: スレッド返信と会話履歴保持が正常に動作 ✅

---

### 継続的改善（Week 7 以降）

#### 優先度: 低（P3）

20. **コスト最適化**

    - タスク: トークン数分析、モデル選択最適化
    - 目標: ユーザー単位コスト $10/月 → $7/月
    - 頻度: 月次レビュー
    - 頻度: 四半期ごと

22. **Red Team テスト**
    - タスク: 外部セキュリティ専門家によるペネトレーションテスト
    - 成果物: 脆弱性レポート、修正計画
    - 頻度: 四半期ごと

---

### リソース配分

| 役割                       | 人数 | 期間     | 主なタスク                       |
| -------------------------- | ---- | -------- | -------------------------------- |
| **バックエンドエンジニア** | 2 名 | Week 1-5 | Lambda 実装、DynamoDB 設計       |
| **セキュリティエンジニア** | 1 名 | Week 2-5 | Guardrails 設定、脆弱性テスト    |
| **QA エンジニア**          | 1 名 | Week 3-5 | BDD テスト、パフォーマンステスト |
| **DevOps エンジニア**      | 1 名 | Week 1-5 | CI/CD、モニタリング、デプロイ    |
| **プロダクトマネージャー** | 1 名 | Week 1-5 | 要件管理、ステークホルダー調整   |

**総工数**: 約 30 人日/週 × 5 週 = 150 人日

---

### リスクと緩和策

| リスク                         | 影響 | 確率 | 緩和策                                             |
| ------------------------------ | ---- | ---- | -------------------------------------------------- |
| Bedrock Guardrails 精度不足    | 高   | 中   | Guardrails 設定の継続的な改善                      |
| レイテンシ超過（>35 秒）       | 中   | 低   | タイムアウトエラーハンドリング、ユーザー通知       |
| コスト超過（>$10/月/ユーザー） | 中   | 中   | トークン制限強化、Cost Explorer アラート           |

---

**ドキュメントバージョン**: 2.3（ロードマップ部分）
**ロードマップ最終レビュー**: 2025-12-06
**管理者**: セキュリティアーキテクチャチーム + AI 運用チーム
