# Feature Specification: Echo Mode Disable — Full Pipeline Validation with TDD

**Feature Branch**: `022-echo-mode-disable-validation`
**Created**: 2026-02-09
**Status**: Draft
**Input**: User description: "エコーモードを無効化した状態での動作を確認。AWS MCP サーバーなどを使ってベストプラクティスを適用。TDD を適用。"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - エコーモード無効時の通常フロー動作確認 (Priority: P1)

運用担当として、エコーモードを無効化（`VALIDATION_ZONE_ECHO_MODE` が `false` または未設定）した状態で Slack からメッセージを送ると、検証ゾーン（Verification Agent）のセキュリティチェック（存在確認・ホワイトリスト認可・レート制限）を通過した後、実行ゾーン（Execution Agent）にリクエストが委譲され、AI 応答が Slack スレッドに返ることを確認できる。

**Why this priority**: エコーモード（017/018）で検証ゾーン単体の動作確認は完了しており、次のステップとして実行ゾーンとの連携を含む通常フローが正しく動くことを確認することが最も重要である。

**Independent Test**: エコーモードを無効にした状態でメッセージを送り、Execution Agent 経由の AI 応答が Slack スレッドに返ることを確認する。ユニットテストでは Execution Agent 呼び出しのモックを使用し、パイプライン全体の分岐を検証する。

**Acceptance Scenarios**:

1. **Given** エコーモードが無効（環境変数未設定または `false`）, **When** ユーザーが Slack でメッセージを送る, **Then** 検証ゾーンのセキュリティチェックを通過後、実行ゾーンにリクエストが委譲される
2. **Given** エコーモードが無効, **When** 実行ゾーンが正常に応答する, **Then** AI 応答テキストが元のスレッドに投稿される
3. **Given** エコーモードが無効, **When** パイプラインが実行される, **Then** `[Echo]` プレフィックスを含む応答は返らず、実行ゾーンの応答内容のみが Slack に投稿される

---

### User Story 2 - セキュリティチェックの TDD による品質保証 (Priority: P1)

開発者として、検証パイプラインの各セキュリティチェック（存在確認・ホワイトリスト認可・レート制限）が、エコーモード無効時に正しく動作することを、テストファーストで保証できる。各チェックの成功・失敗パターンがユニットテストでカバーされている。

**Why this priority**: TDD はこの機能の明示的な要件であり、セキュリティチェックの品質保証はシステムの信頼性に直結する。テストが先に書かれることで、実装の正確性を保証する。

**Independent Test**: 各セキュリティチェックの成功・失敗・エラーケースのユニットテストを先に書き、テストが RED になることを確認した後、実装を追加して GREEN にする。

**Acceptance Scenarios**:

1. **Given** 存在確認が失敗する, **When** パイプラインが実行される, **Then** 実行ゾーンには委譲されず、`existence_check_failed` エラーが返る
2. **Given** ホワイトリスト認可が失敗する, **When** パイプラインが実行される, **Then** 実行ゾーンには委譲されず、`authorization_failed` エラーが返る
3. **Given** レート制限を超過する, **When** パイプラインが実行される, **Then** 実行ゾーンには委譲されず、`rate_limit_exceeded` エラーが返る
4. **Given** すべてのセキュリティチェックが通過する, **When** パイプラインが実行される, **Then** 実行ゾーンへの委譲が行われる

---

### User Story 3 - 実行ゾーンエラー時のグレースフルハンドリング (Priority: P2)

運用担当として、エコーモード無効時に実行ゾーンが失敗した場合、ユーザーフレンドリーなエラーメッセージが Slack スレッドに表示され、システムが安定した状態を維持することを確認できる。

**Why this priority**: 実行ゾーンとの連携ではネットワークエラー・タイムアウト・アクセス拒否など様々な障害が発生しうる。エラー時のユーザー体験とシステム安定性の担保が必要である。

**Independent Test**: Execution Agent の呼び出しをモックし、各種エラーパターン（タイムアウト・スロットリング・アクセス拒否・不正レスポンス）でユーザーフレンドリーなメッセージが返ることをユニットテストで検証する。

**Acceptance Scenarios**:

1. **Given** 実行ゾーンがタイムアウトする, **When** パイプラインが実行される, **Then** ユーザーに対して「時間がかかっています」旨のメッセージが Slack に投稿される
2. **Given** 実行ゾーンがスロットリングエラーを返す, **When** パイプラインが実行される, **Then** ユーザーに対して「混雑しています」旨のメッセージが Slack に投稿される
3. **Given** 実行ゾーンが予期しない例外をスローする, **When** パイプラインが実行される, **Then** 汎用エラーメッセージが Slack に投稿され、例外がログに記録される

---

### User Story 4 - AWS ベストプラクティスの適用 (Priority: P2)

開発者として、検証パイプラインの実装が AWS Well-Architected Framework のベストプラクティス（構造化ログ・メトリクス・エラーハンドリング・IAM 最小権限）に沿っていることを確認できる。

**Why this priority**: AWS MCP サーバーを活用したベストプラクティス適用が明示的な要件であり、本番運用を見据えた品質基準を満たす必要がある。

**Independent Test**: 構造化ログの出力形式、エラーハンドリングパターン、メトリクス出力をユニットテストで検証する。

**Acceptance Scenarios**:

1. **Given** パイプラインの各ステップが実行される, **When** ログが出力される, **Then** すべてのログが JSON 構造化形式で、correlation_id・event_type・level を含む
2. **Given** セキュリティチェックが実行される, **When** 成功・失敗にかかわらず, **Then** 処理時間・結果が構造化ログに記録される
3. **Given** エラーが発生する, **When** エラーハンドリングが実行される, **Then** 内部エラー詳細はログにのみ記録され、ユーザーには安全なメッセージのみが返る

---

### Edge Cases

- エコーモード環境変数が空文字列・未定義・大文字小文字混在（`True`、`TRUE`、`False`、`false`）の場合、すべて正しく解釈されること
- 実行ゾーンのレスポンスが空、`null`、または不正な JSON の場合、汎用エラーメッセージが返りシステムが安定すること
- 実行ゾーンの応答にファイルアーティファクト（添付ファイル）が含まれる場合、テキストとファイルの両方が Slack に投稿されること
- ファイルアーティファクトの Base64 デコードが失敗する場合、テキスト応答のみが投稿されファイルは無視されること
- セキュリティチェック中に DynamoDB 接続エラーが発生した場合の振る舞い（存在確認・認可・レート制限それぞれ）
- 複数メッセージが短時間に送られた場合、レート制限が正しく機能すること

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: エコーモードが無効（環境変数が `false`・空・未設定）の場合、パイプラインはエコー応答を行わず、実行ゾーン（Execution Agent）にリクエストを委譲すること
- **FR-002**: エコーモード無効時、存在確認→ホワイトリスト認可→レート制限の順でセキュリティチェックが実行されること。各チェックが失敗した場合はそこで処理を中断し、適切なエラーレスポンスを返すこと
- **FR-003**: 実行ゾーンの正常応答（テキスト応答・ファイルアーティファクト）を Slack の元スレッドに正しく投稿すること
- **FR-004**: 実行ゾーンのエラー応答に対して、エラーコードに応じたユーザーフレンドリーなメッセージを Slack に投稿すること
- **FR-005**: パイプラインの全ステップ（受信・各セキュリティチェック・委譲・応答投稿）で構造化ログ（JSON 形式、correlation_id 付き）を出力すること
- **FR-006**: すべての機能要件に対して、実装の前にユニットテストを作成する TDD アプローチを採用すること
- **FR-007**: 実行ゾーンからの予期しない例外がパイプライン全体を停止させないよう、例外を捕捉してユーザーフレンドリーなメッセージを返すこと

### Key Entities

- **検証パイプライン (Verification Pipeline)**: Slack からの受信イベントに対してセキュリティチェックを実行し、エコーモード設定に応じてエコー応答または実行ゾーンへの委譲を行うフロー。correlation_id で一貫してトレース可能。
- **実行ペイロード (Execution Payload)**: 検証パイプラインから実行ゾーンに送信されるリクエストデータ。チャンネル・テキスト・スレッド ID・添付ファイル・認証トークン・correlation_id を含む。
- **エラーメッセージマップ**: エラーコードからユーザーフレンドリーなメッセージへの対応表。タイムアウト・スロットリング・アクセス拒否・不正レスポンスなどのパターンをカバー。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: エコーモード無効時、ユーザーが Slack で送信したメッセージに対して実行ゾーン経由の応答が Slack スレッドに 100% 投稿される（正常系）
- **SC-002**: パイプラインの全ユニットテストのカバレッジが主要ビジネスロジック（セキュリティチェック・エコー分岐・実行委譲・エラーハンドリング）に対して 90% 以上である
- **SC-003**: TDD サイクル（RED → GREEN → REFACTOR）が全機能要件に対して適用され、テストが実装より先に書かれたことがコミット履歴で確認できる
- **SC-004**: 構造化ログにより、1 件のリクエストを correlation_id で追跡した場合、受信から応答投稿まで全ステップが確認できる

## Assumptions

- エコーモード（017/018）の実装は既に完了しており、本機能はそのモードを無効化した状態の通常フローを検証・強化する
- 実行ゾーン（Execution Agent）は既にデプロイ済みで、検証ゾーンから呼び出し可能な状態にある（または本テストではモックで代替する）
- AWS ベストプラクティスは、AWS Well-Architected Framework の運用性・信頼性・セキュリティの各柱に沿う。具体的な適用内容は計画フェーズで MCP サーバーを活用して詳細化する
- TDD は Red-Green-Refactor サイクルを指し、テストを先に書いてから実装を行う開発手法を適用する
- 既存のパイプラインコード（`pipeline.py`）の構造を活かし、必要に応じてテスタビリティ向上のためのリファクタリングを行う
