# Research: 柔軟なホワイトリスト認可

**Feature**: 008-flexible-whitelist  
**Date**: 2025-01-30

## Research Questions

### RQ-1: 空のホワイトリスト時の動作変更

**Question**: ホワイトリストが完全に空の場合、現在はfail-closed（全拒否）だが、全許可に変更する。この変更のセキュリティ影響は？

**Decision**: 空のホワイトリスト時は全許可とする。ただし、設定読み込み失敗時（設定ソースが利用不可）は従来通りfail-closedを維持する。

**Rationale**: 
- 空のホワイトリストは管理者が意図的に設定していない状態であり、初期セットアップやテスト環境での柔軟性を提供する
- 設定読み込み失敗はシステムエラーであり、セキュリティ上のリスクがあるためfail-closedを維持
- 既存のfail-closed動作は設定読み込み失敗時にのみ適用され、空のホワイトリストとは区別される

**Alternatives Considered**:
- 空のホワイトリスト時もfail-closedを維持: 初期セットアップ時の柔軟性が失われる
- 警告ログのみで全許可: セキュリティ監査の観点から明示的な動作が好ましい

### RQ-2: 部分的なホワイトリスト設定の実装方法

**Question**: 設定されていないエンティティを無視するロジックをどのように実装するか？

**Decision**: ホワイトリストの各エンティティセット（team_ids、user_ids、channel_ids）が空かどうかをチェックし、空でない場合のみそのエンティティを検証する。

**Rationale**:
- 既存のデータ構造（Dict[str, Set[str]]）をそのまま活用できる
- 空のセットは`len(set) == 0`で判定可能で、シンプルで明確
- 既存のキャッシュメカニズムに影響しない

**Alternatives Considered**:
- 新しい設定フラグを追加: データ構造の変更が必要で、既存の設定ソース（DynamoDB/Secrets Manager/環境変数）との互換性に問題
- 特別な値（例："*"）で全許可を表現: 既存の設定形式との互換性に問題

### RQ-3: 後方互換性の維持方法

**Question**: 既存の全エンティティ設定時の動作（AND条件）をどのように維持するか？

**Decision**: 3つのエンティティすべてが設定されている場合、従来通りすべてをチェックするAND条件を維持する。設定されていないエンティティのみをスキップする。

**Rationale**:
- 既存ユーザーへの影響を最小限に抑える
- 既存のテストケースがそのまま動作する
- 動作の変更は「設定されていないエンティティをスキップ」のみで、設定されているエンティティの動作は変わらない

**Alternatives Considered**:
- 新しい設定形式を導入: 既存ユーザーへの影響が大きい
- デフォルト動作を変更: セキュリティ上のリスクがある

### RQ-4: エラーハンドリングとログ

**Question**: 設定されていないエンティティをスキップする際、ログにどのような情報を記録するか？

**Decision**: 認可チェック時に、設定されているエンティティとスキップされたエンティティをログに記録する。既存のログ形式（structured JSON）を維持し、新しいフィールドを追加する。

**Rationale**:
- セキュリティ監査の観点から、どのエンティティがチェックされ、どのエンティティがスキップされたかを記録する必要がある
- 既存のログ形式を維持することで、既存の監視・アラートシステムとの互換性を保つ

**Alternatives Considered**:
- ログに記録しない: セキュリティ監査の観点から不十分
- 別のログイベントタイプを作成: 既存の監視システムとの互換性に問題

### RQ-5: パフォーマンスへの影響

**Question**: 新しいロジックが認可チェックのパフォーマンスに与える影響は？

**Decision**: パフォーマンスへの影響は最小限。空のセットのチェック（`len(set) == 0`）はO(1)で、既存のセットメンバーシップチェック（`id in set`）もO(1)のまま。

**Rationale**:
- 追加の処理は空のセットチェックのみで、計算量は変わらない
- 既存のキャッシュメカニズム（5分TTL）を維持するため、ホワイトリストの読み込み頻度も変わらない

**Alternatives Considered**:
- キャッシュの構造を変更: 不要な複雑さを追加する
- パフォーマンス最適化のための特別な処理: 現時点では不要

## Implementation Notes

- `authorization.py`の`authorize_request()`関数を修正し、各エンティティのチェック前にホワイトリストセットが空かどうかを確認する
- `whitelist_loader.py`の空のホワイトリストチェック（`total_entries == 0`）を削除または条件付きにする
- 既存のテストケースを更新し、新しい動作をカバーするテストケースを追加する

