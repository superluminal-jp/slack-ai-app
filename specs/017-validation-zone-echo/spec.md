# Feature Specification: Validation Zone Echo for AgentCore Verification

**Feature Branch**: `017-validation-zone-echo`  
**Created**: 2026-02-08  
**Status**: Draft  
**Input**: User description: "Execution zoneへの通信は一旦保留として、Validation zoneの中でslackから受け取った内容をそのまま返す仕組みで動作検証を行うように修正。"

## 概要

Execution zone（実行ゾーン）への通信を一時的に行わず、Validation zone（検証ゾーン）内で Slack から受信した内容をそのまま Slack に返す「エコー」動作に切り替える。**目的は AgentCore（検証ゾーン側の Verification Agent / AgentCore Runtime）の動作確認**であり、実行ゾーンに依存せずに、Slack 受信から認証・Slack 返信までの AgentCore まわりの経路が正しく動くことを検証できるようにする。

## User Scenarios & Testing *(mandatory)*

### User Story 1 - AgentCore（検証ゾーン）単体での動作確認 (Priority: P1)

運用担当として、Slack からボットに送ったメッセージが、実行ゾーンを経由せずに検証ゾーン内の AgentCore（Verification Agent / AgentCore Runtime）で処理され、受信した内容がそのまま Slack のスレッドに返ってくることを確認できる。

**Why this priority**: AgentCore の動作確認が本機能の目的である。実行ゾーンへの呼び出しを止めた状態で、検証ゾーン側の AgentCore（Slack 受信・認可・返信）が正しく動くことを検証する。

**Independent Test**: Slack でボットにメッセージを送り、同じ内容（または受信ペイロードを人間が読める形で）がスレッドに返ることを確認する。実行ゾーンにはリクエストが送られない。

**Acceptance Scenarios**:

1. **Given** ユーザーが Slack でボットにメッセージを送る, **When** 検証ゾーンがイベントを受信する, **Then** 実行ゾーンへの通信は行われず、受信した内容が Slack にそのまま（または判読可能な形で）返る
2. **Given** エコーモードが有効である, **When** 検証ゾーンがリクエストを処理する, **Then** 実行ゾーン側の API やエージェントは呼び出されない
3. **Given** 検証ゾーンで署名検証・認可が通ったリクエスト, **When** エコー応答を返す, **Then** Slack の 3 秒制約を満たすか、または適切な即時応答（例: リアクション）の後にエコー内容がスレッドに投稿される

---

### User Story 2 - エコー内容の明確さ (Priority: P2)

運用担当として、返却される「受信した内容」が、どのリクエストに対する応答か判別でき、必要に応じて AgentCore の動作確認・デバッグに使える情報が含まれることを確認できる。

**Why this priority**: AgentCore の動作確認時に「どのメッセージがエコーされたか」を明確にすることで、検証の信頼性が上がる。

**Independent Test**: 複数回メッセージを送り、それぞれのスレッドに正しいエコーが返ることを確認する。必要に応じてチャンネル・スレッド・ユーザーなどの識別子が分かる形式である。

**Acceptance Scenarios**:

1. **Given** ユーザーがテキスト「テスト」を送る, **When** エコーが返る, **Then** 「テスト」またはそれと等価な受信内容がスレッドに表示される
2. **Given** スレッド A とスレッド B で別々にメッセージを送る, **When** 両方にエコーが返る, **Then** 各スレッドにはそのスレッドで受信した内容のみが返り、混在しない

---

### User Story 3 - 通常モードへの切り戻し (Priority: P2)

運用担当として、AgentCore の動作確認後はエコーモードを無効にし、従来どおり実行ゾーンへ通信する通常動作に戻せることを確認できる。

**Why this priority**: エコーモードは AgentCore 動作確認用の一時的なものであるため、本番相当の動作に戻す手段が必須である。

**Independent Test**: エコーモードを無効化したうえでメッセージを送り、実行ゾーン経由で AI 応答（または従来の応答）が返ることを確認する。

**Acceptance Scenarios**:

1. **Given** エコーモードが無効である, **When** ユーザーがメッセージを送る, **Then** 実行ゾーンが呼び出され、従来の応答フロー（AI 返信等）が行われる
2. **Given** 設定やフラグでエコーモードを切り替え可能である, **When** 運用担当が設定を変更する, **Then** 再デプロイや再起動なしに、または明示的な手順に従って、モードを切り替えられる

---

### Edge Cases

- 受信ペイロードが非常に大きい場合、Slack の投稿制限や検証ゾーンのタイムアウトを超えないよう、エコーする内容の長さや形式に上限を設けるか、要約・省略するかどうか。
- エコーモード有効時、実行ゾーン宛てのキューや非同期トリガーが存在する場合、それらが呼ばれない（または無視される）ことを保証する。
- 複数リージョン・複数環境（dev/staging）で、環境ごとにエコーモードを独立してオン・オフできることが望ましい。

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 検証ゾーンは、設定またはフラグで「エコーモード」を有効にできる。エコーモード有効時、Slack から受信した内容をそのまま（または判読可能な形で）Slack に返すこと。
- **FR-002**: エコーモード有効時、検証ゾーンは実行ゾーンへの通信（API 呼び出し、キュー投入、エージェント起動等）を行ってはならない。
- **FR-003**: エコーとして返す内容は、当該リクエストで受信したデータに基づき、スレッド・チャンネルが混在しないこと。
- **FR-004**: エコーモードは無効化可能であり、無効時は従来どおり実行ゾーンへ通信し、通常の応答フローに戻ること。
- **FR-005**: 検証ゾーンは、Slack の制約（例: 3 秒以内の即時応答）を満たすか、即時応答（リアクション等）の後にエコーをスレッドに投稿するなど、Slack の再試行を招かない応答を行うこと。

### Key Entities

- **受信イベント**: Slack から検証ゾーンに届くリクエスト（本文・メタデータ）。エコー時はこの内容を加工せず、または判読可能な形で返す元とする。
- **エコーモード設定**: エコーを行うか否かを決める設定またはフラグ。環境ごと・デプロイ単位で切り替え可能であることが望ましい。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 運用担当が Slack でメッセージを送り、エコーモード有効時に同じ内容（または等価な表示）がそのスレッドに返ることを 100% 再現でき、これにより **AgentCore（検証ゾーン）の受信〜返信経路が動作していることを確認できる**。
- **SC-002**: エコーモード有効時、実行ゾーン側の API またはエージェントが呼び出されないことを、ログまたはトレースで確認できる。
- **SC-003**: エコーモードを無効にした後、従来どおり実行ゾーン経由の応答が返ることを 1 回以上の動作確認で確認できる。
- **SC-004**: 検証ゾーンの受信から Slack への返信までが、Slack の再試行やタイムアウトを招かずに完了する。

## Assumptions

- 本機能の目的は **AgentCore（検証ゾーン側の Verification Agent / AgentCore Runtime）の動作確認**であり、エコーモードはそのための一時的な手段とする。
- エコーモードは主に開発・検証環境での利用を想定し、本番で常時有効にする必要はない。
- 「受信した内容をそのまま返す」とは、本文テキストのエコーを指し、必要に応じてメタデータ（チャンネル ID・スレッド ID 等）を人間が読める形で含めてもよい。
- 実行ゾーンへの通信を「保留」するとは、呼び出しを行わないことであり、既存の実行ゾーン側コードの変更は本機能の範囲外でもよい（検証ゾーン側の変更で完結する想定）。
