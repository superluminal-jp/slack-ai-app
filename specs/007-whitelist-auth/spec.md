# Feature Specification: ホワイトリスト認可

**Feature Branch**: `007-whitelist-auth`  
**Created**: 2025-01-30  
**Status**: Draft  
**Input**: User description: "ホワイトリスト認可を実装する"

## User Scenarios & Testing _(mandatory)_

### User Story 1 - 認可済みユーザーが AI 機能を利用する (Priority: P1)

認可済みのワークスペース、ユーザー、チャンネルからリクエストが送信された場合、システムはリクエストを承認し、AI 処理を実行する。

**Why this priority**: これは機能の基本動作であり、認可済みユーザーが正常にサービスを利用できることが最優先です。

**Independent Test**: 認可済みの team_id、user_id、channel_id でリクエストを送信し、AI 処理が正常に実行されることを確認できます。これにより、認可機能が正しく動作し、許可されたユーザーがサービスを利用できることを検証できます。

**Acceptance Scenarios**:

1. **Given** 署名検証と Existence Check が成功した状態で、**When** 認可済みの team_id、user_id、channel_id を含むリクエストが送信される、**Then** システムはリクエストを承認し、AI 処理を実行する
2. **Given** 署名検証と Existence Check が成功した状態で、**When** 認可済みの team_id と user_id、認可済みの channel_id を含むリクエストが送信される、**Then** システムはリクエストを承認し、AI 処理を実行する

---

### User Story 2 - 未認可ユーザーがリクエストを送信する (Priority: P1)

未認可のワークスペース、ユーザー、またはチャンネルからリクエストが送信された場合、システムはリクエストを拒否し、セキュリティイベントを記録する。

**Why this priority**: セキュリティの基本原則である fail-closed（失敗時は閉じる）を実現し、未認可アクセスを防ぐことが最優先です。

**Independent Test**: 未認可の team_id、user_id、または channel_id でリクエストを送信し、403 Forbidden が返され、セキュリティログが記録されることを確認できます。これにより、認可機能がセキュリティを正しく保護することを検証できます。

**Acceptance Scenarios**:

1. **Given** 署名検証と Existence Check が成功した状態で、**When** 未認可の team_id を含むリクエストが送信される、**Then** システムは 403 Forbidden を返し、セキュリティイベントをログに記録する
2. **Given** 署名検証と Existence Check が成功した状態で、**When** 未認可の user_id を含むリクエストが送信される、**Then** システムは 403 Forbidden を返し、セキュリティイベントをログに記録する
3. **Given** 署名検証と Existence Check が成功した状態で、**When** 未認可の channel_id を含むリクエストが送信される、**Then** システムは 403 Forbidden を返し、セキュリティイベントをログに記録する

---

### User Story 3 - 管理者がホワイトリストを管理する (Priority: P2)

管理者がホワイトリストに team_id、user_id、channel_id を追加または削除できる。

**Why this priority**: 運用上の柔軟性を提供し、新しいワークスペースやユーザーを追加したり、不要なエントリを削除したりできることが重要です。

**Independent Test**: ホワイトリストに新しい team_id を追加し、その team_id でリクエストが承認されることを確認できます。また、削除した user_id でリクエストが拒否されることを確認できます。これにより、ホワイトリスト管理機能が正しく動作することを検証できます。

**Acceptance Scenarios**:

1. **Given** ホワイトリストに新しい team_id が追加された状態で、**When** その team_id を含むリクエストが送信される、**Then** システムはリクエストを承認する
2. **Given** ホワイトリストから user_id が削除された状態で、**When** その user_id を含むリクエストが送信される、**Then** システムは 403 Forbidden を返す
3. **Given** ホワイトリストに channel_id が追加された状態で、**When** その channel_id を含むリクエストが送信される、**Then** システムはリクエストを承認する

---

### Edge Cases

- **ホワイトリストが空の場合**: すべてのリクエストが拒否される（FR-009）。fail-closed 原則に従い、明示的に認可されていないリクエストは拒否される。
- **ホワイトリストの設定が読み込めない場合**: すべてのリクエストが拒否される（FR-008）。設定ファイルが存在しない、DynamoDB アクセスエラー、Secrets Manager アクセスエラーなど、いかなる理由で設定が読み込めない場合でも、fail-closed 原則に従いリクエストを拒否する。
- **ホワイトリストの更新が行われた場合**: 設定ソースに応じて反映される。環境変数の場合は再デプロイが必要、DynamoDB の場合は即座に反映される（Assumptions 参照）。キャッシュが使用される場合は、キャッシュの TTL に応じて反映が遅延する可能性がある（FR-007）。
- **部分的に認可済みの場合**: リクエストは拒否される（FR-002, FR-003）。team_id、user_id、channel_id の 3 つのエンティティすべてがホワイトリストに含まれている場合のみ承認される。いずれかが未認可であれば、リクエストは拒否される。
- **エンティティ ID が欠落している場合**: 欠落しているエンティティは未認可として扱われ、リクエストは拒否される（FR-002, FR-003）。team_id、user_id、channel_id のいずれかがリクエストに含まれていない場合、そのエンティティは未認可とみなされる。

## Requirements _(mandatory)_

### Functional Requirements

- **FR-001**: システムは、署名検証（3a）と Existence Check（3b）が成功した後、ホワイトリスト認可（3c）を実行しなければならない
- **FR-002**: システムは、team_id、user_id、channel_id の 3 つのエンティティすべてがホワイトリストに含まれている場合のみ、リクエストを承認しなければならない
- **FR-003**: システムは、いずれかのエンティティ（team_id、user_id、channel_id）がホワイトリストに含まれていない場合、403 Forbidden を返し、リクエストを拒否しなければならない
- **FR-004**: システムは、ホワイトリスト認可の結果（成功/失敗）をセキュリティログに記録しなければならない
- **FR-005**: システムは、ホワイトリストの設定を環境変数、AWS Secrets Manager、または DynamoDB から読み込むことができなければならない
- **FR-006**: システムは、ホワイトリスト認可の失敗時に、どのエンティティが未認可であったかをログに記録しなければならない
- **FR-007**: システムは、ホワイトリスト認可のレイテンシを最小化するため、可能な場合はキャッシュを使用しなければならない
- **FR-008**: システムは、ホワイトリストの設定が読み込めない場合、fail-closed 原則に従い、すべてのリクエストを拒否しなければならない
- **FR-009**: システムは、ホワイトリストが空の場合、すべてのリクエストを拒否しなければならない

### Key Entities _(include if feature involves data)_

- **WhitelistEntry**: ホワイトリストに登録されるエンティティを表す。team_id、user_id、channel_id のいずれかまたは複数を含む。各エンティティは独立して管理可能。
- **AuthorizationResult**: 認可の結果を表す。承認/拒否の状態、拒否理由（該当する場合）、検証されたエンティティの情報を含む。

## Success Criteria _(mandatory)_

### Measurable Outcomes

- **SC-001**: 認可済みの team_id、user_id、channel_id を含むリクエストの 100%が正常に承認される
- **SC-002**: 未認可のエンティティを含むリクエストの 100%が 403 Forbidden で拒否される
- **SC-003**: ホワイトリスト認可の処理時間が 50ms 以下（p95）で完了する
- **SC-004**: ホワイトリスト認可の失敗イベントが 1 分以内にセキュリティログに記録される
- **SC-005**: ホワイトリスト設定の読み込みエラーが発生した場合、100%のリクエストが拒否される（fail-closed 原則）

## Assumptions

- ホワイトリストは、team_id、user_id、channel_id の 3 つのエンティティすべてが認可済みである必要がある（AND 条件）
- ホワイトリストの設定は、環境変数、AWS Secrets Manager、または DynamoDB テーブルから読み込まれる
- ホワイトリストの更新は、設定ソース（環境変数の場合は再デプロイ、DynamoDB の場合は即座に反映）に応じて反映される
- ホワイトリスト認可は、署名検証（3a）と Existence Check（3b）の後に実行される
- ホワイトリスト認可の失敗は、セキュリティイベントとして記録され、モニタリングシステムに通知される

## Dependencies

- 署名検証（3a）が実装済みであること
- Existence Check（3b）が実装済みであること
- セキュリティログ記録機能が利用可能であること
- AWS Secrets Manager または DynamoDB へのアクセス権限があること

## Out of Scope

- ホワイトリスト管理 UI の実装（本機能では設定の読み込みのみを対象とする）
- 動的なホワイトリスト更新 API の実装（設定ソースの更新は別途行う）
- ロールベースアクセス制御（RBAC）の実装（本機能はシンプルなホワイトリスト認可のみを対象とする）
- 時間ベースのアクセス制御（特定時間帯のみアクセス許可など）
