# Feature Specification: Async AgentCore Invocation

**Feature Branch**: `016-async-agentcore-invocation`  
**Created**: 2026-02-08  
**Status**: Draft  
**Input**: User description: "非同期パターンで実装。AWS MCPや公式ドキュメントを参照して最適なシステムを構築する"

## 概要

Slack でボットにメンションすると、イベント受信側は短時間で応答を返し、AI エージェントの実行は非同期に処理するようにする。これにより、エージェントの実行時間が長くてもイベント受信側のタイムアウトで処理が打ち切られず、ユーザーにはエージェント完了後に Slack へ返信が届く。

### 運用コンテキスト

**現状**: イベント受信処理がエージェント実行の完了を同期的に待つため、エージェント実行が一定時間を超えるとイベント受信側がタイムアウトし、ユーザーに返信が届かない（👀 のみで終わる）。

**変更後**: イベント受信処理は即座に成功応答を返し、エージェント実行は別の非同期フローで実行する。エージェント完了後に Slack へ投稿する責務は既存の検証エージェント（または同等の仕組み）が担う。設計・実装では AWS 公式ドキュメントおよび AWS MCP を参照し、最適な非同期パターンを採用する。

## User Scenarios & Testing _(mandatory)_

### User Story 1 - メンション後に確実に返信が届く (Priority: P1)

エンドユーザーとして、Slack でボットにメンションして質問を送ると、処理に時間がかかっても AI の返信がスレッドに届くことを確認できる。

**Why this priority**: 同期的な待ち合わせによるタイムアウトを解消し、ユーザーが返信を受け取れない事象をなくすことが本機能の主目的である。

**Independent Test**: Slack でメンションを送り、エージェント実行が従来のタイムアウト時間を超えても、完了後に Slack に返信が投稿されることを確認する。

**Acceptance Scenarios**:

1. **Given** ユーザーが Slack でボットにメンションを送る, **When** イベント受信処理が受け付ける, **Then** 受信処理は数秒以内に成功応答を返し、Slack の再試行を招かない
2. **Given** エージェント実行が長時間（例: 60 秒超）かかる, **When** 実行が完了する, **Then** ユーザーにはスレッドに AI の返信が届く
3. **Given** 複数ユーザーが同時にメンションする, **When** それぞれのイベントが受信される, **Then** 各リクエストは非同期に処理され、それぞれのスレッドに正しい返信が届く

---

### User Story 2 - イベント受信はブロックしない (Priority: P1)

運用担当として、Slack イベントの受信処理がエージェント実行の完了を待たずに終了し、受信処理のタイムアウトで処理が打ち切られないことを確認できる。

**Why this priority**: 非同期化の根幹は「受信処理の実行時間」と「エージェント実行時間」の分離である。受信処理がブロックしないことで、プラットフォームの実行時間制限の影響を受けにくくなる。

**Independent Test**: イベント受信から成功応答までの時間を計測し、エージェント実行時間に依存せず短時間（例: 10 秒以内）で終了することを確認する。

**Acceptance Scenarios**:

1. **Given** Slack がイベントを送信する, **When** 受信処理が検証・認可を完了する, **Then** 受信処理はエージェント実行を開始したうえで、その完了を待たずに成功応答を返す
2. **Given** 受信処理が成功応答を返した, **When** エージェントがまだ実行中である, **Then** エージェント実行は別の実行コンテキストで継続し、完了時に Slack へ投稿される
3. **Given** 非同期でエージェント実行を開始する仕組みが導入されている, **When** 設計・実装を確認する, **Then** AWS 公式ドキュメントおよびベストプラクティス（必要に応じて AWS MCP で検証）に沿った方式である

---

### User Story 3 - 既存の「実行結果を Slack に投稿する」責務の維持 (Priority: P1)

開発者として、非同期化後も「エージェントの出力を Slack に投稿する」責務が検証ゾーン（または同等の境界）にあり、過去の非同期パターン（例: 実行ゾーンからキュー経由で検証ゾーンが受け取り Slack に投稿）と整合した設計であることを確認できる。

**Why this priority**: 責任分離と一貫した非同期パターンを保つことで、運用・障害切り分け・将来拡張がしやすくなる。

**Independent Test**: 非同期フローを追跡し、エージェント完了から Slack 投稿までが既存の検証ゾーン（またはそれに相当するコンポーネント）経由であることを確認する。

**Acceptance Scenarios**:

1. **Given** エージェントが実行を完了する, **When** 結果をユーザーに届ける, **Then** Slack への投稿は検証ゾーン（または同等の境界）のコンポーネントが行う
2. **Given** 非同期で「実行リクエスト」を渡す仕組みを導入する, **When** アーキテクチャを説明する, **Then** 既存の「実行結果をキュー経由で検証ゾーンが受け取り Slack に投稿する」パターンと概念的に整合している（同じキューを使うか、別のキュー・トリガーであっても責務の流れが明確である）

---

### User Story 4 - 障害・再試行の扱い (Priority: P2)

運用担当として、非同期処理の途中で障害が起きた場合に、再試行やデッドレターによりメッセージが失われにくく、必要に応じて監視・アラートできることを確認できる。

**Why this priority**: 非同期化後は「受信」と「実行・投稿」が分離するため、中間の信頼性（少なくとも 1 回配信、再試行、DLQ 等）を明示的に設計する必要がある。

**Independent Test**: 非同期処理の失敗シナリオ（例: キュー投入失敗、実行タイムアウト）を再現し、再試行または DLQ にメッセージが移ることを確認する。

**Acceptance Scenarios**:

1. **Given** 非同期で「実行リクエスト」を投入する処理が失敗する, **When** 設計に従って再試行またはエラー処理が行われる, **Then** 可能な範囲でリクエストが再試行され、ユーザーには分かりやすいエラーまたは遅延が伝わる
2. **Given** エージェント実行または Slack 投稿が繰り返し失敗する, **When** 上限に達する, **Then** メッセージはデッドレター等に移り、監視・手動対応が可能である

---

### Edge Cases

- イベント受信直後に非同期投入に失敗した場合、受信処理は 200 を返した後に失敗するため、Slack は再送する可能性がある。重複排除（既存のイベント ID ベース）で同一イベントの二重処理を防ぐ。
- 非同期キューやトリガーが一時的に利用できない場合、受信処理はエラーを返すか、限定的なリトライのうえでエラーにし、Slack の再送に委ねる。設計時に「受信処理の失敗」と「非同期実行の失敗」を区別できるようにする。
- エージェント実行が長時間または無期限に近い場合、プラットフォーム側の制限（キュー可視性タイムアウト、実行コンテキストの最大時間）に従い、必要ならハートビート・延長やタイムアウト後のエラー投稿を設計する。

## Requirements _(mandatory)_

### Functional Requirements

- **FR-001**: システムは、Slack イベントを受信した際に、エージェント実行の完了を待たずに成功応答を返さなければならない（非同期受付）。
- **FR-002**: システムは、受信したイベントに基づくエージェント実行を、受信処理とは別の実行コンテキストで開始し、完了まで継続できるようにしなければならない。
- **FR-003**: システムは、エージェント実行が完了したら、既存の責務分離に従い検証ゾーン（または同等の境界）経由で Slack に返信を投稿しなければならない。
- **FR-004**: システムは、非同期投入（キュー送信や非同期 API 呼び出し）の失敗を検知し、適切にログおよび必要に応じて再試行またはエラー応答で扱わなければならない。
- **FR-005**: システムは、同一 Slack イベントが重複して処理されないよう、既存のイベント ID ベースの重複排除を維持しなければならない。
- **FR-006**: 非同期パターン（キュー、非同期 API、トリガー等）の選定と実装は、AWS 公式ドキュメントおよびベストプラクティスを参照し、必要に応じて AWS MCP を用いて検証する。

### Key Entities

- **Slack イベント**: Slack から送られるメンション等のペイロード。イベント ID、チャンネル、スレッド、ユーザー情報を含む。重複排除のキーとなる。
- **実行リクエスト**: 受信処理が非同期に渡す「このイベントに対してエージェントを実行せよ」というリクエスト。チャンネル、スレッド、ユーザー入力、相関 ID 等を含む。
- **実行結果 / 投稿ペイロード**: エージェントが生成した返信およびメタデータ。検証ゾーン（または同等）が Slack に投稿する内容の元となる。

## Success Criteria _(mandatory)_

### Measurable Outcomes

- **SC-001**: ユーザーが Slack でボットにメンションした後、エージェント実行に 60 秒以上かかっても、完了から 30 秒以内にスレッドに返信が表示される（タイムアウトによる「返信なし」が解消される）。
- **SC-002**: イベント受信から成功応答までの時間は、エージェント実行時間に依存せず、通常 10 秒以内である（受信処理がブロックしていないことを示す）。
- **SC-003**: 非同期投入の失敗時、再試行またはエラー扱いが行われ、監視・ログで追跡可能である。
- **SC-004**: 設計・実装が、AWS 公式ドキュメントおよび推奨パターンに沿っていることを、AWS MCP またはドキュメント参照で確認できる。

## Assumptions

- Slack のイベント配信は既存と同様（3 秒以内の応答を期待する等）であり、本機能では受信処理が短時間で 200 を返すことでこれを満たす。
- 検証ゾーン（Verification Agent またはそれに相当するコンポーネント）は、実行結果を受け取り Slack に投稿する責務を引き続き持つ。非同期化は「受信 → 実行開始」の部分を分離するのみとする。
- 既存の重複排除（イベント ID、DynamoDB 等）はそのまま利用し、非同期化後も同一イベントの二重実行を防ぐ。
- AWS 上でキューや非同期トリガー等を利用する場合、既存の 011 で採用した「実行ゾーン → SQS → 検証ゾーン → Slack」のようなパターンを参照し、必要に応じて同種のコンポーネントを流用または拡張する。
