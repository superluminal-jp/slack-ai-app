# Feature Specification: Verification Zone Slack Response Handling

**Feature Branch**: `011-verification-slack-response`  
**Created**: 2025-01-30  
**Status**: Draft  
**Input**: User description: "実行ゾーンは外部の API を呼び出すことも想定して、slack への返答も検証ゾーンで受け持つようにしたい。"

## 概要

本仕様は、Slack AI アプリケーションのアーキテクチャを変更し、Execution Zone（実行層）からのレスポンスを Verification Zone（検証層）経由で Slack に投稿するように再設計します。これにより、Execution Zone は外部 API（Bedrock 含む）の呼び出しに専念し、Slack への通信は Verification Zone が一元管理する責任分離を実現します。

### 運用コンテキスト

**現状**: Execution Zone が Bedrock API を呼び出した後、直接 Slack API にレスポンスを投稿している  
**変更後**: Execution Zone は外部 API を呼び出し、結果を Verification Zone に返す。Verification Zone が Slack への投稿を担当する

この変更により：

- Execution Zone は Slack API への直接アクセスが不要になり、外部 API 呼び出しに専念できる
- Verification Zone が Slack への通信を一元管理し、セキュリティ境界が明確になる
- 将来的に Execution Zone が他の外部 API（OpenAI、Anthropic など）を呼び出す場合も、同じパターンで対応可能
- クロスアカウント構成でも、Execution Zone が Slack API へのアクセス権限を持つ必要がなくなる

## User Scenarios & Testing _(mandatory)_

### User Story 1 - 検証ゾーン経由での Slack 投稿 (Priority: P1)

エンドユーザーとして、Slack で AI アプリに質問を送信すると、検証ゾーンを経由して AI レスポンスが Slack に投稿されることを確認できます。

**Why this priority**: これは本機能の主要な動作であり、すべてのユーザー体験の基盤となります。

**Independent Test**: Slack からメッセージを送信し、検証ゾーンが実行ゾーンからのレスポンスを受け取り、Slack に投稿することを確認します。

**Acceptance Scenarios**:

1. **Given** ユーザーが Slack で AI アプリに質問を送信する, **When** 実行ゾーンが Bedrock API を呼び出してレスポンスを生成する, **Then** 実行ゾーンはレスポンスを検証ゾーンに返し、検証ゾーンが Slack に投稿する

2. **Given** 実行ゾーンが正常な AI レスポンスを生成した, **When** 検証ゾーンがレスポンスを受け取る, **Then** 検証ゾーンは適切なチャンネルとスレッドにレスポンスを投稿する

3. **Given** 実行ゾーンがエラーレスポンスを返した, **When** 検証ゾーンがエラーレスポンスを受け取る, **Then** 検証ゾーンはユーザーフレンドリーなエラーメッセージを Slack に投稿する

---

### User Story 2 - 実行ゾーンの外部 API 呼び出し専念 (Priority: P1)

システムアーキテクトとして、実行ゾーンが Slack API への直接アクセスを持たず、外部 API（Bedrock、将来的には他の AI サービス）の呼び出しに専念できることを確認できます。

**Why this priority**: 責任の分離とセキュリティ境界の明確化は、システムの拡張性と保守性に直結します。

**Independent Test**: 実行ゾーンが Slack API を直接呼び出していないことを確認し、外部 API 呼び出しのみを行っていることを検証します。

**Acceptance Scenarios**:

1. **Given** 実行ゾーンがデプロイされている, **When** 実行ゾーンの IAM ロールとコードを確認する, **Then** Slack API へのアクセス権限や呼び出しコードが存在しない

2. **Given** 実行ゾーンが Bedrock API を呼び出す, **When** レスポンスが生成される, **Then** 実行ゾーンはレスポンスを検証ゾーンに返すのみで、Slack API を呼び出さない

3. **Given** 将来的に実行ゾーンが他の外部 API（例: OpenAI API）を呼び出す必要がある, **When** 新しい API 統合を追加する, **Then** 同じパターン（レスポンスを検証ゾーンに返す）で対応できる

---

### User Story 3 - 検証ゾーンによる Slack 通信の一元管理 (Priority: P1)

セキュリティ管理者として、Slack への通信が検証ゾーンで一元管理され、セキュリティ境界が明確になることを確認できます。

**Why this priority**: セキュリティ境界の明確化は、セキュリティ監査とコンプライアンスに重要です。

**Independent Test**: 検証ゾーンが Slack API へのすべての通信を担当し、実行ゾーンが Slack API にアクセスしないことを確認します。

**Acceptance Scenarios**:

1. **Given** システムが正常に動作している, **When** Slack への通信を監査する, **Then** すべての通信が検証ゾーンから発信されている

2. **Given** 検証ゾーンが Slack API へのアクセス権限を持つ, **When** 実行ゾーンがレスポンスを返す, **Then** 検証ゾーンは適切な認証情報（Bot Token）を使用して Slack に投稿する

3. **Given** クロスアカウント構成で実行ゾーンが別アカウントにある, **When** 実行ゾーンがレスポンスを返す, **Then** 実行ゾーンは Slack API へのアクセス権限が不要で、検証ゾーンのみが Slack API にアクセスする

---

### User Story 4 - エラーハンドリングとフォールバック (Priority: P2)

エンドユーザーとして、実行ゾーンまたは検証ゾーンでエラーが発生した場合でも、適切なエラーメッセージが Slack に表示されることを期待します。

**Why this priority**: エラーハンドリングはユーザー体験の重要な要素であり、システムの信頼性に直結します。

**Independent Test**: 各種エラーシナリオ（実行ゾーンエラー、検証ゾーンエラー、ネットワークエラー）で適切なエラーメッセージが表示されることを確認します。

**Acceptance Scenarios**:

1. **Given** 実行ゾーンが Bedrock API 呼び出しに失敗した, **When** エラーレスポンスが検証ゾーンに返される, **Then** 検証ゾーンはユーザーフレンドリーなエラーメッセージを Slack に投稿する

2. **Given** 検証ゾーンが実行ゾーンからのレスポンスを受け取れない（タイムアウトなど）, **When** タイムアウトが発生する, **Then** 検証ゾーンは「処理に時間がかかっています」などのメッセージを Slack に投稿する

3. **Given** 検証ゾーンが Slack API への投稿に失敗した, **When** 投稿エラーが発生する, **Then** エラーがログに記録され、必要に応じてリトライまたはエラー通知が行われる

---

### Edge Cases

- **実行ゾーンからのレスポンスが不正な形式の場合**: 検証ゾーンはエラーハンドリングを行い、適切なエラーメッセージを Slack に投稿する
- **実行ゾーンがタイムアウトした場合**: 検証ゾーンはタイムアウトを検出し、ユーザーに適切なメッセージを返す
- **検証ゾーンが Slack API への投稿に失敗した場合**: エラーをログに記録し、必要に応じてリトライまたは管理者に通知する
- **実行ゾーンが複数の外部 API を呼び出す場合**: すべてのレスポンスを統合して検証ゾーンに返す
- **レスポンスサイズが大きい場合**: 検証ゾーンは Slack のメッセージサイズ制限を考慮し、必要に応じて分割投稿する

## Requirements _(mandatory)_

### Functional Requirements

#### 実行ゾーンの変更

- **FR-001**: 実行ゾーンは Slack API への直接アクセスを行ってはならない
- **FR-002**: 実行ゾーンは外部 API（Bedrock 含む）を呼び出し、結果を検証ゾーンに返さなければならない
- **FR-003**: 実行ゾーンからのレスポンスには、以下の情報を含めなければならない:
  - AI レスポンステキスト（成功時）
  - エラーメッセージ（エラー時）
  - エラーコード（エラー時）
  - チャンネル ID（Slack 投稿に必要）
  - スレッドタイムスタンプ（スレッド返信に必要）
  - 相関 ID（トレーシング用）
- **FR-004**: 実行ゾーンは IAM ロールから Slack API へのアクセス権限を削除しなければならない

#### 検証ゾーンの変更

- **FR-005**: 検証ゾーンは実行ゾーンからのレスポンスを受け取り、Slack API に投稿しなければならない
- **FR-006**: 検証ゾーンは実行ゾーンからのレスポンスを検証し、不正な形式の場合はエラーハンドリングを行わなければならない
- **FR-007**: 検証ゾーンは実行ゾーンからのレスポンスを受け取れない場合（タイムアウトなど）、適切なエラーメッセージを Slack に投稿しなければならない
- **FR-008**: 検証ゾーンは Slack API への投稿に失敗した場合、エラーをログに記録し、必要に応じてリトライを行わなければならない
- **FR-009**: 検証ゾーンは Slack のメッセージサイズ制限を考慮し、必要に応じてレスポンスを分割投稿できなければならない

#### API 通信プロトコル

- **FR-010**: 実行ゾーンから検証ゾーンへのレスポンスは、既存の API Gateway 経由で返されなければならない
- **FR-011**: レスポンス形式は JSON で、構造化された形式でなければならない
- **FR-012**: 実行ゾーンは非同期処理（Bedrock API 呼び出し）を完了した後、検証ゾーンにレスポンスを返さなければならない
- **FR-013**: 検証ゾーンは実行ゾーンからのレスポンスを待機する必要がある（同期または非同期コールバックパターン）

#### エラーハンドリング

- **FR-014**: 実行ゾーンがエラーを返した場合、検証ゾーンはユーザーフレンドリーなエラーメッセージを Slack に投稿しなければならない
- **FR-015**: 検証ゾーンが実行ゾーンからのレスポンスを受け取れない場合、タイムアウトエラーメッセージを Slack に投稿しなければならない
- **FR-016**: 検証ゾーンが Slack API への投稿に失敗した場合、エラーをログに記録し、管理者に通知できなければならない

#### 後方互換性

- **FR-017**: 既存の API Gateway エンドポイントとリクエスト形式は維持しなければならない（検証ゾーンから実行ゾーンへのリクエスト）
- **FR-018**: レスポンス形式の変更は、既存のエラーハンドリングロジックと互換性を保たなければならない

### Key Entities

- **ExecutionResponse**: 実行ゾーンから検証ゾーンに返されるレスポンス。AI レスポンステキスト、エラー情報、メタデータを含む
- **SlackPostRequest**: 検証ゾーンが Slack API に投稿する際のリクエスト。チャンネル ID、メッセージテキスト、スレッドタイムスタンプを含む
- **ResponseHandler**: 検証ゾーン内で実行ゾーンからのレスポンスを処理し、Slack に投稿するコンポーネント

### Assumptions

- **API Gateway パターン**: 既存の API Gateway 経由の通信パターンを維持し、レスポンスも同じ経路で返す
- **非同期処理**: 実行ゾーンの Bedrock API 呼び出しは非同期で、完了後に検証ゾーンにレスポンスを返す
- **レスポンス待機**: 検証ゾーンは実行ゾーンからのレスポンスを待機する必要がある（同期または非同期コールバック）
- **エラーハンドリング**: 既存のエラーハンドリングパターンを維持し、ユーザーフレンドリーなメッセージを提供する
- **メッセージサイズ**: Slack のメッセージサイズ制限（約 4000 文字）を考慮し、必要に応じて分割投稿する
- **タイムアウト**: 実行ゾーンからのレスポンス待機には適切なタイムアウトを設定する（既存の 30 秒タイムアウトを維持）

## Success Criteria _(mandatory)_

### Measurable Outcomes

- **SC-001**: エンドユーザーは、Slack で AI アプリに質問を送信してから 30 秒以内にレスポンスを Slack で受け取れる（既存のパフォーマンスを維持）
- **SC-002**: 実行ゾーンは Slack API への直接アクセスを 100% 排除し、外部 API 呼び出しに専念できる
- **SC-003**: 検証ゾーンは実行ゾーンからのレスポンスを 100% 受け取り、Slack に正常に投稿できる（成功率 99% 以上）
- **SC-004**: エラー発生時、ユーザーは 5 秒以内に適切なエラーメッセージを Slack で受け取れる
- **SC-005**: システムは既存の API Gateway エンドポイントとリクエスト形式を維持し、後方互換性を 100% 保つ
- **SC-006**: 実行ゾーンの IAM ロールから Slack API へのアクセス権限が 100% 削除される
- **SC-007**: 検証ゾーンは Slack への通信を 100% 一元管理し、すべての Slack API 呼び出しが検証ゾーンから発信される
