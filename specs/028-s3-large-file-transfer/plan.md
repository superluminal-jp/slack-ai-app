# Implementation Plan: S3-backed Large File Artifact

**Branch**: `028-s3-large-file-transfer` | **Date**: 2026-02-11 | **Spec**: [spec.md](./spec.md)  
**Input**: Feature specification from `/specs/028-s3-large-file-transfer/spec.md`

## Summary

SQS の 256 KB 制限を回避するため、大容量ファイル（200 KB 超）を既存の file-exchange S3 バケットにアップロードし、SQS メッセージには署名付き URL のみを含める方式を導入する。200 KB 以下のファイルは従来どおりインライン（contentBase64）で送信し、後方互換性を維持する。

## Technical Context

**Language/Version**: Python 3.11 (Verification Agent, Slack Poster Lambda), TypeScript 5.x (CDK)  
**Primary Dependencies**: boto3, FastAPI, uvicorn, slack-sdk, aws-cdk-lib  
**Storage**: S3 (file-exchange バケット), 既存 `attachments/` に加え `generated_files/` プレフィックス追加  
**Testing**: pytest (verification-agent, slack-poster)  
**Target Platform**: AWS (ECS Fargate, Lambda), ap-northeast-1  
**Project Type**: CDK-managed serverless (Verification Agent, Execution Agent, Slack Poster Lambda)  
**Performance Goals**: 大容量ファイルを 60 秒以内に Slack 投稿完了  
**Constraints**: SQS メッセージ ≤ 256 KB（従来環境）、署名付き URL 有効期限 15 分  
**Scale/Scope**: 既存 file-exchange バケットに 1 プレフィックス追加。Verification Agent パイプライン分岐。Slack Poster の file_artifact 処理拡張。

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Gate | Status | Notes |
|------|--------|-------|
| Library-First / Modularity | PASS | 既存 s3_file_manager, slack_post_request を拡張。新規モジュール不要 |
| Test-First | PASS | test_pipeline, test_s3_file_manager, slack-poster 試験でカバー |
| Integration Testing | PASS | 閾値超過時の E2E フロー検証が計画に含まれる |
| Observability | PASS | 既存の構造化ログに s3_upload, artifact_type 等を追加 |
| Security (最小権限) | PASS | grantReadWrite は generated_files/* のみ追加。既存パターン準拠 |

## Project Structure

### Documentation (this feature)

```text
specs/028-s3-large-file-transfer/
├── plan.md              # This file
├── research.md          # Phase 0 output
├── data-model.md        # Phase 1 output
├── quickstart.md        # Phase 1 output
├── contracts/           # Phase 1 output (slack-post-request 拡張)
└── tasks.md             # Phase 2 output (/speckit.tasks)
```

### Source Code (repository root)

```text
cdk/
├── lib/verification/
│   ├── constructs/
│   │   ├── file-exchange-bucket.ts    # 変更: generated_files/ ライフサイクル追加
│   │   └── verification-agent-runtime.ts  # 変更: grantReadWrite generated_files/*
│   └── agent/verification-agent/
│       ├── s3_file_manager.py        # 変更: upload_generated_file_to_s3, generate_presigned_url_for_generated_file
│       ├── pipeline.py                # 変更: サイズ閾値分岐、S3 アップロード
│       └── slack_post_request.py      # 変更: build_file_artifact 拡張（S3 形式対応）
├── lib/verification/lambda/slack-poster/
│   └── handler.py                     # 変更: s3PresignedUrl 対応
specs/019-slack-poster-separation/contracts/
└── slack-post-request.md             # 参照: 028 で拡張契約を contracts/ に追加
```

**Structure Decision**: 既存 CDK スタックと Verification Agent 構造を維持。変更は既存ファイルの拡張のみ。

## Phase 0: Research (Complete)

- [x] SQS メッセージサイズ制限調査
- [x] S3 署名付き URL ベストプラクティス
- [x] S3 ライフサイクルルール
- [x] 契約拡張設計

## Phase 1: Design Artifacts (Complete)

- [x] data-model.md
- [x] contracts/slack-post-request-extended.md
- [x] quickstart.md

## Phase 2: Task Breakdown

*To be generated by `/speckit.tasks`.*

## Complexity Tracking

> No constitution violations requiring justification.
