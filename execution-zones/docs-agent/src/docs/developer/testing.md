# テストガイド

**目的**: テストシナリオ、コンプライアンス基準、トレーサビリティマトリクスを提供する。
**対象読者**: 開発者、QA エンジニア
**最終更新日**: 2026-02-14

## 9.1 添付ファイル処理のテストシナリオ

### 画像添付ファイルの処理

```gherkin
フィーチャー: 画像添付ファイルの処理
  ユーザー体験として
  システムは画像添付ファイルを処理してAI分析に含める必要がある
  視覚的な内容を理解した応答を提供するため

  背景:
    前提 ボットがチャンネルに追加されている
    かつ ボットにfiles:readスコープが付与されている
    かつ ユーザーが画像を添付してメッセージを送信できる

  シナリオ: PNG画像の処理
    前提 ユーザーがPNG画像を添付してメッセージを送信する
    もし システムがメッセージを処理する
    ならば 画像がダウンロードされる必要がある
    かつ 画像がBedrock APIに送信される必要がある
    かつ AI応答が画像の内容を参照する必要がある

  シナリオ: 複数画像の処理
    前提 ユーザーが2つの画像を添付してメッセージを送信する
    もし システムがメッセージを処理する
    ならば すべての画像が処理される必要がある
    かつ AI応答がすべての画像を参照する必要がある

  シナリオ: 画像サイズ超過
    前提 ユーザーが15MBの画像を添付してメッセージを送信する
    もし システムがメッセージを処理する
    ならば エラーメッセージが返される必要がある
    かつ エラーメッセージは "画像が大きすぎます（最大 10MB）" である必要がある
```

### ドキュメント添付ファイルの処理

```gherkin
フィーチャー: ドキュメント添付ファイルの処理
  ユーザー体験として
  システムはドキュメント添付ファイルからテキストを抽出してAI分析に含める必要がある
  ドキュメントの内容を理解した応答を提供するため

  背景:
    前提 ボットがチャンネルに追加されている
    かつ ボットにfiles:readスコープが付与されている

  シナリオ: PDFドキュメントの処理
    前提 ユーザーがPDFファイルを添付してメッセージを送信する
    もし システムがメッセージを処理する
    ならば PDFからテキストが抽出される必要がある
    かつ 抽出されたテキストがBedrock APIに送信される必要がある
    かつ AI応答がドキュメントの内容を参照する必要がある

  シナリオ: DOCXドキュメントの処理
    前提 ユーザーがDOCXファイルを添付してメッセージを送信する
    もし システムがメッセージを処理する
    ならば DOCXからテキストが抽出される必要がある
    かつ テーブルやヘッダーからもテキストが抽出される必要がある

  シナリオ: 未対応ファイル形式
    前提 ユーザーがZIPファイルを添付してメッセージを送信する
    もし システムがメッセージを処理する
    ならば エラーメッセージが返される必要がある
    かつ エラーメッセージは対応ファイル形式を明示する必要がある
```

### エラーハンドリング

```gherkin
フィーチャー: 添付ファイル処理のエラーハンドリング
  セキュリティ管理として
  システムは添付ファイル処理エラーを適切に処理する必要がある
  ユーザーに明確なフィードバックを提供し、システム情報を漏洩しないため

  背景:
    前提 ボットがチャンネルに追加されている

  シナリオ: ダウンロード失敗
    前提 ユーザーが画像を添付してメッセージを送信する
    かつ 画像が削除されている
    もし システムがメッセージを処理する
    ならば エラーメッセージが返される必要がある
    かつ エラーメッセージは "画像のダウンロードに失敗しました" である必要がある
    かつ システム内部の詳細が漏洩しない必要がある

  シナリオ: 部分成功（複数添付ファイル）
    前提 ユーザーが有効な画像と無効なファイルを添付してメッセージを送信する
    もし システムがメッセージを処理する
    ならば 有効な画像は処理される必要がある
    かつ 無効なファイルについてエラーメッセージが返される必要がある
```

## 9.2 セキュリティ検証（BDD シナリオ）

### Existence Check (Two-Key Defense)

```gherkin
フィーチャー: Two-Key Defense - Existence Check
  セキュリティ管理として
  システムはSigning SecretとBot Tokenの両方を使用してリクエストを検証する必要がある
  署名シークレット漏洩時でも攻撃を防ぐため

  背景:
    前提 システムに有効なBot Tokenがある
    かつ システムがリクエストの署名を検証済みである

  シナリオ: 有効な署名と偽造team_id
    前提 リクエストに有効な署名がある
    かつ リクエストに存在しないteam_id "T_INVALID"が含まれている
    もし システムがExistence Checkを実行する
    ならば システムはリクエストを403 Forbiddenで拒否する必要がある
    かつ システムはセキュリティイベント "existence_check_failed" をログに記録する必要がある
    かつ セキュリティイベントにはteam_id "T_INVALID"が含まれる必要がある

  シナリオ: 有効な署名と偽造user_id
    前提 リクエストに有効な署名がある
    かつ リクエストに存在しないuser_id "U_INVALID"が含まれている
    もし システムがExistence Checkを実行する
    ならば システムはリクエストを403 Forbiddenで拒否する必要がある
    かつ システムはセキュリティイベント "existence_check_failed" をログに記録する必要がある

  シナリオ: 有効な署名と偽造channel_id
    前提 リクエストに有効な署名がある
    かつ リクエストに存在しないchannel_id "C_INVALID"が含まれている
    もし システムがExistence Checkを実行する
    ならば システムはリクエストを403 Forbiddenで拒否する必要がある
    かつ システムはセキュリティイベント "existence_check_failed" をログに記録する必要がある

  シナリオ: 有効な署名とすべて有効なエンティティ
    前提 リクエストに有効な署名がある
    かつ リクエストに有効なteam_id "T01234567"が含まれている
    かつ リクエストに有効なuser_id "U01234567"が含まれている
    かつ リクエストに有効なchannel_id "C01234567"が含まれている
    もし システムがExistence Checkを実行する
    ならば システムはリクエストを受け入れる必要がある
    かつ システムは "existence_check_success" をログに記録する必要がある

  シナリオ: Bot Tokenが利用不可
    前提 リクエストに有効な署名がある
    かつ Bot Tokenが利用できない
    もし システムがExistence Checkを実行する
    ならば システムはExistence Checkをスキップする必要がある
    かつ システムは "existence_check_skipped" を理由 "bot_token_unavailable" でログに記録する必要がある
    かつ システムはリクエストの処理を続行する必要がある

  シナリオ: Slack APIタイムアウト
    前提 リクエストに有効な署名がある
    かつ リクエストに有効なteam_id "T01234567"が含まれている
    かつ Slack APIが2秒後にタイムアウトする
    もし システムがExistence Checkを実行する
    ならば システムはリクエストを403 Forbiddenで拒否する必要がある
    かつ システムはセキュリティイベント "existence_check_timeout" をログに記録する必要がある

  シナリオ: Slack APIレート制限
    前提 リクエストに有効な署名がある
    かつ リクエストに有効なteam_id "T01234567"が含まれている
    かつ Slack APIがレート制限エラー（429）を返す
    もし システムがExistence Checkを実行する
    ならば システムは指数バックオフ（1s, 2s, 4s）でリトライする必要がある
    かつ すべてのリトライが失敗した場合、システムはリクエストを403 Forbiddenで拒否する必要がある
    かつ システムはセキュリティイベント "existence_check_rate_limit" をログに記録する必要がある

  シナリオ: キャッシュヒット
    前提 リクエストに有効な署名がある
    かつ リクエストに有効なteam_id "T01234567"が含まれている
    かつ 同じteam_id/user_id/channel_idの組み合わせが5分以内に検証済みである
    もし システムがExistence Checkを実行する
    ならば システムはキャッシュから結果を取得する必要がある
    かつ システムはSlack APIを呼び出さない必要がある
    かつ システムは "existence_check_cache_hit" をログに記録する必要がある
```

### Slack API Existence Check（動的エンティティ検証）

```gherkin
フィーチャー: Slack API Existence Check
  セキュリティ管理として
  システムは Slack API を使用してエンティティの存在を動的に検証する必要がある
  Signing Secret 漏洩時の攻撃を防ぐため

  背景:
    前提 署名検証が成功している
    かつ Bot Token が利用可能である
    かつ Existence Check キャッシュが空である

  シナリオ: 実在するエンティティでのリクエスト
    前提 team_id "T01234567" がワークスペース "AcmeCorp" として実在する
    かつ user_id "U01234567" がユーザー "alice" として実在する
    かつ channel_id "C01234567" がチャンネル "#general" として実在する
    もし SlackEventHandler が Existence Check を実行する
    ならば Slack API team.info が成功する必要がある
    かつ Slack API users.info が成功する必要がある
    かつ Slack API conversations.info が成功する必要がある
    かつ エンティティがキャッシュに保存される必要がある（TTL: 5 分）
    かつ レスポンスステータスコードは 200 である必要がある

  シナリオ: 偽造された team_id でのリクエスト（Signing Secret 漏洩攻撃）
    前提 攻撃者が Signing Secret を入手している
    かつ 攻撃者が偽の team_id "T99999999" を使用する
    かつ team_id "T99999999" は実在しない
    もし SlackEventHandler が Existence Check を実行する
    ならば Slack API team.info が "team_not_found" エラーを返す必要がある
    かつ レスポンスステータスコードは 403 である必要がある
    かつ エラーメッセージは "不正なワークスペースが検出されました" である必要がある
    かつ セキュリティアラート "ExistenceCheckFailed" がトリガーされる必要がある
    かつ CloudWatch メトリクス "ExistenceCheckFailed" が +1 される必要がある

  シナリオ: 偽造された user_id でのリクエスト
    前提 team_id "T01234567" が実在する
    かつ user_id "U99999999" が実在しない
    かつ channel_id "C01234567" が実在する
    もし SlackEventHandler が Existence Check を実行する
    ならば Slack API users.info が "user_not_found" エラーを返す必要がある
    かつ レスポンスステータスコードは 403 である必要がある
    かつ セキュリティアラートがトリガーされる必要がある

  シナリオ: キャッシュヒット時のパフォーマンス
    前提 エンティティ "{T01234567}#{U01234567}#{C01234567}" がキャッシュに存在する
    かつ キャッシュの TTL が有効である（<5 分）
    もし SlackEventHandler が Existence Check を実行する
    ならば Slack API 呼び出しがスキップされる必要がある
    かつ キャッシュから検証結果が取得される必要がある
    かつ レイテンシは <50ms である必要がある
    かつ CloudWatch メトリクス "ExistenceCheckCacheHitRate" が更新される必要がある

  シナリオ: Slack API レート制限時の動作
    前提 team_id、user_id、channel_id がすべて実在する
    かつ Slack API が 429 エラー（レート制限）を返す
    もし SlackEventHandler が Existence Check を実行する
    ならば 指数バックオフでリトライする必要がある（最大 3 回）
    かつ リトライ後も失敗した場合、レスポンスステータスコードは 503 である必要がある
    かつ エラーメッセージは "現在サービスが混雑しています" である必要がある

  シナリオ: Slack API ダウン時の fail-closed 動作
    前提 team_id、user_id、channel_id がすべて実在する
    かつ Slack API がタイムアウトする（>2 秒）
    もし SlackEventHandler が Existence Check を実行する
    ならば リクエストは拒否される必要がある（fail-closed）
    かつ レスポンスステータスコードは 503 である必要がある
    かつ エラーメッセージは "Slack API との通信に失敗しました" である必要がある
    かつ CloudWatch メトリクス "SlackAPITimeout" が +1 される必要がある
```

## 9.2 品質ゲート & コンプライアンス

### コンプライアンス標準（AI 特有を含む）

### コンプライアンス標準（AI 特有を含む）

| 標準                         | 要件                           | 実装                                                     |
| ---------------------------- | ------------------------------ | -------------------------------------------------------- |
| **SOC 2 Type II**            | アクセス制御、ログ、暗号化     | IAM ポリシー、CloudWatch、KMS                            |
| **GDPR**                     | データ最小化、削除権           | コンテキスト履歴暗号化、ユーザーデータ削除 API           |
| **個人情報保護法（日本）**   | 個人情報の適切な管理           | アクセス制御、監査ログ                                   |
| **AI Act（EU、2024）**       | AI 透明性、人間の監視          | モデルバージョン記録、Guardrails 適用ログ                |
| **ISO/IEC 42001（AI 管理）** | AI リスク管理、ガバナンス      | 脅威モデル、Guardrails、監査証跡                         |

## 9.3 トレーサビリティマトリクス

### 脅威 → セキュリティ管理 → テスト

| 脅威 ID | 脅威                       | セキュリティ管理                                                        | 検証（BDD シナリオ）                                         | テストファイル                                |
| ------- | -------------------------- | ----------------------------------------------------------------------- | ------------------------------------------------------------ | --------------------------------------------- |
| T-01    | 署名シークレット漏洩       | **Slack API Existence Check** + SlackEventHandler 認可 + モニタリング | `existence_check.feature::偽造された team_id でのリクエスト` | `tests/bdd/features/existence_check.feature`  |
| T-11    | モデル乱用（コスト）       | トークン制限、ユーザー単位クォータ                                      | 手動負荷テスト                                               | `tests/security/test_token_limits.py`         |
| T-12    | コンテキスト履歴情報漏洩   | コンテキスト ID 分離、DynamoDB 暗号化                                   | アクセス制御テスト                                           | `tests/security/test_context_isolation.py`    |

---

---

## 関連ドキュメント

- [セキュリティ要件](./security.md) - セキュリティ要件とテストケース
- [セキュリティ実装](./security.md) - 実装詳細
- [アーキテクチャ](./architecture.md) - システムアーキテクチャ概要

---

**最終更新日**: 2026-02-14
