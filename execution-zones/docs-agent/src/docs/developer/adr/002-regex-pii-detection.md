# ADR-002: 正規表現ベース PII 検出の採用

**目的**: PII 検出に正規表現を採用した決定と理由を記録する。
**対象読者**: 開発者、アーキテクト
**最終更新日**: 2026-02-14

**ステータス**: Accepted
**決定日**: 2025-11-30
**決定者**: セキュリティチーム、コンプライアンスチーム

### コンテキスト

GDPR、個人情報保護法への準拠のため、AI 応答から PII（個人識別情報）を自動検出・マスキングする必要があります。

**制約**:

- **AWS Comprehend の限界**: 日本語 PII 検出に未対応（英語・スペイン語のみ）
- **処理時間**: BedrockProcessor の 30 秒タイムアウト内で完了必須
- **精度要件**: Recall ≥85%（見逃しを最小化）

### 決定

**正規表現ベースの PII 検出を実装**（AWS Comprehend 不使用）

検出パターン:

```python
PII_PATTERNS = {
    "EMAIL": r'\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b',
    "PHONE": r'0\d{1,4}-?\d{1,4}-?\d{4}',
    "CARD": r'\b\d{4}[-\s]?\d{4}[-\s]?\d{4}[-\s]?\d{4}\b',
    "URL": r'https?://[^\s<>"{}|\\^`\[\]]+',
}
```

### 代替案の検討

| 手法                              | 長所                           | 短所                             | 不採用理由             |
| --------------------------------- | ------------------------------ | -------------------------------- | ---------------------- |
| **AWS Comprehend**                | ML 精度高い、多様な PII タイプ | 日本語未対応、API 呼び出しコスト | 日本語非対応           |
| **AWS Translate + Comprehend**    | 間接的に日本語対応可能         | レイテンシ増大、翻訳精度低下     | パフォーマンス要件未達 |
| **Azure AI Language**             | 日本語 PII 検出対応            | AWS 外部、ネットワーク経由       | クラウド戦略不一致     |
| **サードパーティ ML（Presidio）** | 多言語対応、精度良好           | Lambda Layer 肥大化、運用コスト  | シンプルさ優先         |

### 結果（Consequences）

**ポジティブ**:

- **レイテンシ**: <10ms（Comprehend API の 100〜300ms 比）
- **コスト**: ゼロ（API 呼び出しなし）
- **日本語対応**: 正規表現で電話番号、メール、カード番号検出可能
- **シンプル**: 外部依存なし、デバッグ容易

**ネガティブ・トレードオフ**:

- **精度限界**: 名前、住所の検出困難（構造化されていない）
- **False Positives**: 電話番号パターンが一般的な数字列に誤検出
- **保守性**: 新しい PII パターン追加時に正規表現修正必要

**技術的負債**:

- 将来的に Comprehend 日本語対応時の移行計画
- 定期的なパターン精度レビュー（四半期ごと）
- ML-based 検出への段階的移行パス

### 検証方法

- **精度テスト**: 1000 件の日本語テストデータで Recall/Precision 測定
- **False Positive 率**: 月次でマスキングログをサンプリングレビュー
- **ユーザーフィードバック**: PII 漏洩報告の有無を追跡

### 関連資料

- [AWS Comprehend 言語サポート](https://docs.aws.amazon.com/comprehend/latest/dg/supported-languages.html)
- 内部 PII 検出精度レポート: `docs/security/pii-detection-accuracy-analysis.pdf`

---

---

## 関連ドキュメント

- [セキュリティ要件](../security.md) - PII保護要件
- [実装詳細](../architecture.md) - PII検出実装コード
- [テストと検証](../testing.md) - PII保護テストシナリオ

---

**最終更新日**: 2026-02-13
